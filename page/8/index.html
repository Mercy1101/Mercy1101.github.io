<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"mercy1101.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
<meta property="og:type" content="website">
<meta property="og:title" content="李建聪的博客">
<meta property="og:url" content="https://mercy1101.github.io/page/8/index.html">
<meta property="og:site_name" content="李建聪的博客">
<meta property="og:description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
<meta property="og:locale">
<meta property="article:author" content="李建聪">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://mercy1101.github.io/page/8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'cn'
  };
</script>

  <title>李建聪的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">李建聪的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/07/05/2020-07-05-%E9%98%85%E8%AF%BBspdlog-rotating_file_sink%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/05/2020-07-05-%E9%98%85%E8%AF%BBspdlog-rotating_file_sink%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">阅读spdlog-rotating_file_sink源码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-05 09:59:47" itemprop="dateCreated datePublished" datetime="2020-07-05T09:59:47+08:00">2020-07-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-28 14:29:44" itemprop="dateModified" datetime="2023-10-28T14:29:44+08:00">2023-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">源码阅读</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1>thread_pool 源码学习</h1>
<h2 id="rotating-file-sink定义">rotating_file_sink定义</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/gabime/spdlog/blob/v1.x/include/spdlog/sinks/rotating_file_sink.h">rotating_file_sink.h</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Rotating file sink based on size</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Mutex&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">rotating_file_sink</span> <span class="keyword">final</span> : <span class="keyword">public</span> base_sink&lt;Mutex&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">rotating_file_sink</span>(<span class="type">filename_t</span> base_filename, std::<span class="type">size_t</span> max_size, std::<span class="type">size_t</span> max_files, <span class="type">bool</span> rotate_on_open = <span class="literal">false</span>);</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">filename_t</span> <span class="title">calc_filename</span><span class="params">(<span class="type">const</span> <span class="type">filename_t</span> &amp;filename, std::<span class="type">size_t</span> index)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">filename_t</span> <span class="title">filename</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sink_it_</span><span class="params">(<span class="type">const</span> details::log_msg &amp;msg)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">flush_</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// Rotate files:</span></span><br><span class="line">    <span class="comment">// log.txt -&gt; log.1.txt</span></span><br><span class="line">    <span class="comment">// log.1.txt -&gt; log.2.txt</span></span><br><span class="line">    <span class="comment">// log.2.txt -&gt; log.3.txt</span></span><br><span class="line">    <span class="comment">// log.3.txt -&gt; delete</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">rotate_</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delete the target if exists, and rename the src file  to target</span></span><br><span class="line">    <span class="comment">// return true on success, false otherwise.</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">rename_file_</span><span class="params">(<span class="type">const</span> <span class="type">filename_t</span> &amp;src_filename, <span class="type">const</span> <span class="type">filename_t</span> &amp;target_filename)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">filename_t</span> base_filename_;          <span class="comment">///&lt; 基础文件名称</span></span><br><span class="line">    std::<span class="type">size_t</span> max_size_;              <span class="comment">///&lt; 最大单个文件大小</span></span><br><span class="line">    std::<span class="type">size_t</span> max_files_;             <span class="comment">///&lt; 最大日志文件数量</span></span><br><span class="line">    std::<span class="type">size_t</span> current_size_;          <span class="comment">///&lt; 当前文件的大小</span></span><br><span class="line">    details::file_helper file_helper_;  <span class="comment">///&lt; 用于辅助写文件的对象</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="构造函数">构造函数</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/// @name     rotating_file_sink</span></span><br><span class="line"><span class="comment">/// @brief    构造本对象，</span></span><br><span class="line"><span class="comment">///           1. 打开日志文件</span></span><br><span class="line"><span class="comment">///           2. 获取当前文件大小</span></span><br><span class="line"><span class="comment">///           3. 如果超出了单个文件大小，则重新创建文件并打开</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param    base_filename   [in]  基础的文件名</span></span><br><span class="line"><span class="comment">/// @param    max_size        [in]  最大单个文件大小</span></span><br><span class="line"><span class="comment">/// @param    max_files       [in]  最大的文件</span></span><br><span class="line"><span class="comment">/// @param    rotate_on_open  [in]  是否在文件打开时rotate</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-07-04 21:51:27</span></span><br><span class="line"><span class="built_in">rotating_file_sink</span>(std::string base_filename, std::<span class="type">size_t</span> max_size,</span><br><span class="line">                   std::<span class="type">size_t</span> max_files, <span class="type">bool</span> rotate_on_open = <span class="literal">false</span>)</span><br><span class="line">    : <span class="built_in">base_filename_</span>(std::<span class="built_in">move</span>(base_filename)),</span><br><span class="line">      <span class="built_in">max_size_</span>(max_size),</span><br><span class="line">      <span class="built_in">max_files_</span>(max_files) &#123;</span><br><span class="line">  <span class="comment">/// 打开当前应该写入的文件，并由file_helper对象来持有这个文件指针</span></span><br><span class="line">  file_helper_.<span class="built_in">open</span>(<span class="built_in">calc_filename</span>(base_filename_, <span class="number">0</span>));</span><br><span class="line">  <span class="comment">/// 该函数时间执行时间很长，在这里只执行一次。</span></span><br><span class="line">  current_size_ = file_helper_.<span class="built_in">size</span>();</span><br><span class="line">  <span class="comment">/// 假如允许rotate且当前文件大小大于零</span></span><br><span class="line">  <span class="keyword">if</span> (rotate_on_open &amp;&amp; current_size_ &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/// 执行一次rotate</span></span><br><span class="line">    <span class="built_in">rotate_</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="rotate-函数">rotate_()函数</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @name     rotate_</span></span><br><span class="line"><span class="comment">/// @brief    执行循环日志文件的创建</span></span><br><span class="line"><span class="comment">/// @details</span></span><br><span class="line"><span class="comment">/// Rotate files:</span></span><br><span class="line"><span class="comment">/// log.txt -&gt; log.1.txt</span></span><br><span class="line"><span class="comment">/// log.1.txt -&gt; log.2.txt</span></span><br><span class="line"><span class="comment">/// log.2.txt -&gt; log.3.txt</span></span><br><span class="line"><span class="comment">/// log.3.txt -&gt; delete</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param    NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @return   NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-07-04 21:58:24</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">rotate_</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// 首先关闭该文件</span></span><br><span class="line">  file_helper_.<span class="built_in">close</span>();</span><br><span class="line">  <span class="comment">/// 开始查找要创建的下一个日志文件名称</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i = max_files_; i &gt; <span class="number">0</span>; --i) &#123;</span><br><span class="line">    <span class="comment">/// 拼装出上一个该文件名称</span></span><br><span class="line">    std::string src = <span class="built_in">calc_filename</span>(base_filename_, i - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">path_exists</span>(src)) &#123;</span><br><span class="line">      <span class="comment">/// 该文件如果不存在则到下一个循环</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// 这里找到要创建的日志名称了日志文件的名称</span></span><br><span class="line">    std::string target = <span class="built_in">calc_filename</span>(base_filename_, i);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 把上一个文件改名为当前的文件名</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">rename_file_</span>(src, target)) &#123;</span><br><span class="line">      <span class="comment">/// 如果失败则在一个短暂的延迟后再次尝试</span></span><br><span class="line">      <span class="built_in">sleep_for_millis</span>(<span class="number">100</span>);</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">rename_file_</span>(src, target)) &#123;</span><br><span class="line">        <span class="comment">/// 关闭并打开这个日志文件，防止它增长超出限制</span></span><br><span class="line">        file_helper_.<span class="built_in">reopen</span>(<span class="literal">true</span>);</span><br><span class="line">        current_size_ = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/// 抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span>(<span class="string">&quot;rotating_file_sink: failed renaming &quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/// 以追加模式(&quot;a&quot;)重新打开这个文件</span></span><br><span class="line">  file_helper_.<span class="built_in">reopen</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="虚函数的实现">虚函数的实现</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @name   sink_it_</span></span><br><span class="line"><span class="comment">/// @brief  写文件日志的函数，如果写入日志大于最大文件大小则创建下一个文件</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param  msg [in]  写入的日志信息</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @return</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-07-05 09:33:12</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sink_it_</span><span class="params">(<span class="type">const</span> details::log_msg &amp;msg)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  std::string formatted;</span><br><span class="line">  <span class="comment">/// 拼装日志信息</span></span><br><span class="line">  base_sink&lt;Mutex&gt;::formatter_-&gt;format(msg, formatted);</span><br><span class="line">  <span class="comment">/// 计算这条日志加上原本大小是否超过了最大文件大小</span></span><br><span class="line">  current_size_ += formatted.<span class="built_in">size</span>();</span><br><span class="line">  <span class="keyword">if</span> (current_size_ &gt; max_size_) &#123;</span><br><span class="line">    <span class="comment">/// 超过了就创建下一个文件</span></span><br><span class="line">    <span class="built_in">rotate_</span>();</span><br><span class="line">    <span class="comment">/// 更新为当前文件大小为这个日志信息的大小</span></span><br><span class="line">    current_size_ = formatted.<span class="built_in">size</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/// 如果没有超过最大大小则继续写该文件</span></span><br><span class="line">  file_helper_.<span class="built_in">write</span>(formatted);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// @name     flush_</span></span><br><span class="line"><span class="comment">/// @brief    刷新文件</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param    NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @return   NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-07-05 09:36:23</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">flush_</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; file_helper_.<span class="built_in">flush</span>(); &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/07/04/2020-07-04-C++%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/04/2020-07-04-C++%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">C++异常处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-04 11:11:05" itemprop="dateCreated datePublished" datetime="2020-07-04T11:11:05+08:00">2020-07-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-28 14:29:44" itemprop="dateModified" datetime="2023-10-28T14:29:44+08:00">2023-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1>异常处理</h1>
<p>​<strong>异常处理</strong>（<code>exception handling</code>）机制允许程序独立开发的部分能够在运行时就出现问题<strong>进行通信</strong>并作出<strong>相应的处理</strong>。异常是的我们能够将问题的检测和解决过程分离开来。程序的一部分负责检测问题的出现，然后解决该问题的任务传递给程序的另一部分。检测环节无需知道问题处理模块的所有细节，反之亦然。</p>
<h2 id="1-抛出异常">1. 抛出异常</h2>
<p>​在C++语言中，我们通过<strong>抛出</strong>(<code>throwing</code>)一条表达式来<strong>引发</strong>(<code>raised</code>)一个异常。被抛出的表达式的类型以及当前的调用链共同决定了哪段<strong>处理代码</strong>(<code>handler</code>)将被用来处理该异常。被选中的处理代码实在调用链中与抛出对象类型匹配的最近的处理代码。其中，根据抛出对象的类型和内容，程序的异常抛出部分会告知异常处理部分到底发生了什么错误。</p>
<p>​当执行一个<code>throw</code>时，跟在<code>throw</code>后面的语句将不再被执行。相反，程序的控制权从<code>throw</code>转移到与之匹配的<code>catch</code>模块。该<code>catch</code><strong>可能是同一函数中</strong>的局部<code>catch</code>，<strong>也可能位于直接或间接调用了发生异常的函数的另一个函数中</strong>。控制权从一处转移到另一处，这有两个重要的含义：</p>
<ul>
<li><strong>沿着调用链的函数可能会提早退出</strong>。</li>
<li><strong>一旦程序开始执行异常处理代码，则沿着调用链创建的对象将被销毁</strong>。</li>
</ul>
<p>因为跟在<code>throw</code>后面的语句将不再被执行，所以<code>throw</code>语句的有类似于<code>return</code>语句：它通常作为条件语句的一部分或者作为某个函数的最后(或者唯一)一条语句。</p>
<h3 id="1-1-栈展开">1.1 栈展开</h3>
<p>​<strong>当抛出一个异常后</strong>，程序暂停当前函数的执行过程并立即开始寻找与异常匹配的<code>catch</code>子句。</p>
<ul>
<li>
<p>当<code>throw</code>出现在一个<strong>try语句块</strong>(<code>try block</code>)内时，检查与该<code>try</code>块关联的<code>catch</code>子句。</p>
</li>
<li>
<p>如果找到了匹配的<code>catch</code>，就使用该<code>catch</code>处理异常。</p>
</li>
<li>
<p>如果这一步<strong>没找到匹配</strong>的<code>catch</code><strong>且该<code>try</code>语句嵌套在其他<code>try</code>块中</strong>，则<strong>继续检查与外层<code>try</code>匹配的<code>catch</code>子句</strong>。</p>
</li>
<li>
<p>如果<strong>还是找不到匹配</strong>的<code>catch</code>，则<strong>退出当前函数</strong>，在调<strong>用当前函数的外层函数中</strong>继续寻找。</p>
</li>
<li>
<p>如果对抛出异常的函数的调用语句位于一个<code>try</code>语句块内，则检查与该<code>try</code>块关联的<code>catch</code>子句。</p>
</li>
<li>
<p>如果找到了匹配的<code>catch</code>，就使用该<code>catch</code>处理异常。</p>
</li>
<li>
<p>否则，如果该<code>try</code>语句嵌套在其他<code>try</code>块中，则继续检查与外层<code>try</code>匹配的<code>catch</code>子句。</p>
</li>
<li>
<p>如果仍然没找到匹配的<code>catch</code>，则退出当前这个主调函数，继续在调用刚刚退出的这个函数的其他函数中寻找，以此类推。</p>
</li>
</ul>
<p>​上述过程被称为<strong>栈展开</strong>(<code>stack unwinding</code>)过程。栈展开过程沿着嵌套函数的调用链不断查找，直到找到了与异常匹配的<code>catch</code>子句为止；或者也可能一致没找到匹配的<code>catch</code>，则退出主函数后过程中止。</p>
<p>​假设找到了一个匹配的<code>catch</code>子句，则程序进入该子句并执行其中代码。当执行完这个<code>catch</code>子句后，找到与<code>try</code>块关联的最后一个<code>catch</code>子句后的点，并从这里继续执行。</p>
<p>​<strong>如果没有找到匹配的<code>catch</code>子句，程序将退出</strong>。因为异常通常被认为是妨碍程序正常执行的事件，所以一旦引发了某个异常，就不能对它置之不理。当找不到匹配的<code>catch</code>时，程序将调用标准库函数<code>terminate</code>，顾名思义，<code>terminate</code>负责中止程序的执行过程。</p>
<h3 id="1-2-栈展开过程中对象被自动销毁">1.2 栈展开过程中对象被自动销毁</h3>
<p>​在栈展开过程中，位于调用链上的语句块可能会提前退出。如果在<strong>栈展开过程中</strong>退出了某个块，编译器将负责确保在这个块中<strong>创建的对象都能被正确的销毁</strong>。如果某个局部对象的类型是<strong>类类型</strong>，则<strong>该对象的析构函数将被自动调用</strong>。与往常一样，编译器在销毁内置类型的对象时不需要做任何事情。</p>
<p>​如果异常发生在构造函数中，则当前的对象可能只构造了一部分。有的成员已经开始初始化了，而另外一些成员在异常发生前也许还没有开始初始化。即使某个对象只构造了一部分，我们也要<strong>确保构造的成员能被正确的销毁</strong>（否则会发生内存泄露）。</p>
<p>​类似的，异常也可能发生在<strong>数组</strong>或<strong>标准库容器的元素初始化过程</strong>中。与之前类似，如果在异常发生前已经构造了一部分元素，则我们应该确保这部分元素被正确的销毁。</p>
<h3 id="1-3-析构函数与异常">1.3 析构函数与异常</h3>
<p>​析构函数总是会被执行的，但是函数中负责释放资源的代码却可能会被跳过。如果一个块分配了资源，并且在<strong>负责释放这些资源的代码前面发生了异常</strong>，则释放资源的代码将<strong>不会被执行</strong>。另一方面，类对象分配的资源将由类的析构函数负责释放。因此，如果我们使用类来控制资源的分配，就能确保无论函数正常结束还是遭遇异常，资源都能被正确地释放。（<code>RAII</code>的思想，在构造函数中获取资源(i.e <code>new</code>)，在析构函数中释放资源(i.e <code>delete</code>)。）</p>
<p>​所以出于栈展开可能使用析构函数的考虑，析构函数不应该抛出不能被它自身处理的异常。换句话说，<strong>如果析构函数需要执行某个可能抛出异常的操作，则该操作应该被放置在一个try语句块当中，并且在析构函数内部得到处理</strong>（如果不这样做的话，程序会马上被终止）。</p>
<blockquote>
<p>注：所有标准库类型都能保证它们的析构函数不会引发异常。</p>
</blockquote>
<h3 id="1-4-异常对象">1.4 异常对象</h3>
<p><strong>异常对象</strong>（<code>exception object</code>）是一种特殊的对象，编译器使用<strong>异常抛出表达式</strong>来对<strong>异常对象</strong>进行<strong>拷贝初始化</strong>。因此<code>throw</code>语句中的表达式必须拥有<strong>完整类型</strong>。而且如果该表达式是<strong>类类型</strong>的话，则相应的类必须含有一个<strong>可访问的析构函数</strong>和一个<strong>可访问的拷贝或移动构造函数</strong>。如果该表达式是<strong>数组类型</strong>或<strong>函数类型</strong>，则表达式将被<strong>转换成</strong>与之对应的<strong>指针类型</strong>。</p>
<p>​异常对象位于有编译器管理的空间中，编译器确保无论调用哪个<code>catch</code>子句都能访问该空间。异常处理完毕后，异常对象被销毁。</p>
<p>​当一个异常被抛出是，沿着调用链的块将依次退出直至找到与异常匹配的处理代码。如果退出某个块，则同时释放块中局部对象使用的内存。因此，抛出一个指向<strong>局部对象的指针</strong>几乎肯定是一种<strong>错误</strong>行为。如果指针所指的对象位于某个块中，而该块在<code>catch</code>语句之前就已经退出了，则意味着在执行<code>catch</code>语句之前局部对象已经被销毁了。</p>
<p>​当我们抛出一条表达式时，该表达式的静态编译时类型决定了异常对象的类型。很多情况下程序抛出的表达式类型来自于某个继承体系。如果一条<code>throw</code>表达式<strong>解引用一个基类指针</strong>，而该指针<strong>实际指向的是派生类对象</strong>，则<strong>抛出的对象将被切掉一部分，只有基类部分被抛出</strong>。</p>
<blockquote>
<p>注： 抛出指针要求在任何对应处理代码存在的地方，指针所指的对象都必须存在。</p>
</blockquote>
<h2 id="2-捕获异常">2. 捕获异常</h2>
<p><code>catch</code>子句（<code>catch clause</code>）中的一场声明（<code>exception declaration</code>）看起来像是只包含一个形参的函数形参列表。像在形参列表中一样，如果<code>catch</code>无须访问抛出的表达式的话，则我们可以忽略捕获形参的名字。</p>
<p>声明的类型决定了处理代码所能捕获的异常类型。这个类型必须是完全类型，它可以是左值引用，不能是右值引用。当进入一个<code>catch</code>语句后，入参通过异常对象初始化异常声明中的参数。和函数的参数类似，如果<code>catch</code>的参数类型是非引用类型，则该参数是异常对象的一个副本，如果参数是引用类型，则和其他引用参数一样，该参数是异常对象的一个别名。</p>
<p>如果<code>catch</code>的参数是基类类型，则我们可以使用其派生类类型的异常对象对其进行初始化。此时，如果<code>catch</code>的参数是非引用类型，则异常对象将被切掉一部分，如果<code>catch</code>的参数是基类的引用，则该参数将以常规方式绑定到异常对象上。</p>
<p>最后一点需要注意的是，异常声明的静态类型将决定<code>catch</code>语句所能执行的操作。如果<code>catch</code>的参数是基类类型，则<code>catch</code>无法使用派生类特有的任何成员。</p>
<blockquote>
<p>Tips: 通常情况下，如果<code>catch</code>接收的异常与某个继承体系有关，则最好将该<code>catch</code>的参数定义成引用类型。</p>
</blockquote>
<h3 id="2-1-查找匹配的处理代码">2.1 查找匹配的处理代码</h3>
<p>​在搜寻<code>catch</code>语句的过程中，我们最终找到的<code>catch</code>未必是异常的最佳匹配。相反，挑选出来的应该是第一个与异常匹配的<code>catch</code>语句。因此，越是专门的<code>catch</code>越应该置于整个<code>catch</code>列表的前端。</p>
<p>​因为<code>catch</code>语句是按照其出现的顺序逐一匹配的，所以当程序员使用具有继承关系的多个异常时必须对<code>catch</code>语句的顺序进行组织管理，是的派生类异常的处理代码出现在基类异常的处理代码异常之前。</p>
<p>​与实参和形参的匹配规则相比，异常和<code>catch</code>异常声明的匹配规则受到更多限制。此时，绝大多数类型转换都不被允许，除了一些极细小的差别之外，要求异常的类型和<code>catch</code>声明的类型时精确匹配的：</p>
<ul>
<li>允许从非常量的类型转换，也就是说一条非常量对象的<code>throw</code>语句可以匹配一个接受常量引用的<code>catch</code>语句</li>
<li>允许从派生类向基类的类型转换。</li>
<li>数组被转换成指向数组（元素）类型的指针，函数被转化成指向该函数类型的指针。</li>
</ul>
<p>除此之外，包括标准算术类型转换和类类型转换在内，其他所有转换规则都不能在匹配catch的过程中使用。</p>
<blockquote>
<p>如果在多个catch语句的类型之间存在着继承关系，则我们应该把继承链最低端的类（<code>most derived type</code>）放在前面，而将继承链最顶端的类（<code>least derived type</code>）放在后面。</p>
</blockquote>
<h3 id="2-2-重新抛出">2.2 重新抛出</h3>
<p>​一个单独的<code>catch</code>语句不能完整的处理某个异常。在执行了某些校正操作之后，当前的<code>catch</code>可能会决定由调用链更上一层的函数接着处理异常。一条catch语句通过重新抛出的操作将异常传递给另外一个<code>catch</code>语句。这里的重新抛出仍然是一条<code>throw</code>语句，只不过不包含任何表达式: <code>throw;</code></p>
<p>​空的<code>throw</code>语句只能出现在<code>catch</code>语句或<code>catch</code>语句直接或间接调用的函数之内。如果在处理代码之外的区域遇到了空<code>throw</code>语句，编译器将调用<code>terminate</code>。</p>
<p>​一个重新抛出语句并不指定新的表达式，而是将当前的异常对象沿着调用链向上传递。</p>
<p>​很多时候，catch语句会改变其参数内容。如果在改变了参数的内容后catch语句重新抛出异常，则只有当catch异常声明是引用类型时我们对参数所作的改变才会被保留并继续传播。</p>
<h3 id="2-3-捕获所有异常的处理代码">2.3 捕获所有异常的处理代码</h3>
<p>​为了一次性捕获所有异常，我们使用省略号作为异常声明，这样的处理代码称为捕获所有异常的处理代码，形如<code>catch(...)</code>.</p>
<p>​<code>catch(...)</code>通常与重新抛出语句一起使用，其中<code>catch</code>执行当前局部能完成的工作，随后重新抛出异常。</p>
<blockquote>
<p>Tips: 如果<code>catch(...)</code>与其他几个<code>catch</code>语句一起出现，则<code>catch(...)</code>必须在最后的位置。出现在捕获所有一场语句后面的<code>catch</code>语句将永远不会被匹配。</p>
</blockquote>
<h2 id="3-函数try语句块与构造函数">3. 函数try语句块与构造函数</h2>
<p>​通常情况下，程序执行的任何时刻都可能发生异常，特别是一场可能发生在处理构造函数初始值的过程中。构造函数在进入其函数体之前首先执行初始值列表。因为在初始值列表抛出异常时构造函数体内的<code>try</code>语句块还未生效，所以构造函数体内的<code>catch</code>语句无法处理构造函数初始值列表抛出的异常。</p>
<p>​要想处理构造函数初始值抛出的异常，我们必须将构造函数写成<strong>函数try语句块</strong>（<code>function try block</code>）的形式。函数<code>try</code>语句使得一组<code>catch</code>语句既能处理构造函数体（或析构函数体），也能处理构造函数的初始化过程（或析构函数的析构过程）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">Blob&lt;T&gt;::<span class="built_in">Blob</span>(std::initializer_list&lt;T&gt; il)</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line"> : <span class="built_in">data</span>(std::make_shared&lt;std::vector&lt;T&gt;&gt;(il))</span><br><span class="line">&#123;<span class="comment">/** ... */</span>&#125;</span><br><span class="line"><span class="built_in">catch</span> (<span class="type">const</span> std::bad_alloc &amp;e)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">handle_out_of_memory</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-noexcept-异常说明">4. noexcept 异常说明</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">recoup</span><span class="params">()</span> <span class="keyword">noexcept</span></span>; <span class="comment">/** 不会抛出异常 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">alloc</span><span class="params">()</span></span>;           <span class="comment">/** 可能会抛出异常 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>对于一个函数来说，noexcept说明要么出现在该函数的所有声明语句和定义语句中，要么一次也不出现。该说明应该在函数应该在函数的尾置返回类型之前。</p>
</li>
<li>
<p>我们也可以在函数指针的声明和定义中指定<code>noexcept</code>。</p>
</li>
<li>
<p>在typedef或类型别名中则不能出现<code>noexcept</code>。</p>
</li>
<li>
<p>在成员函数中，<code>noexcept</code>说明符需要跟在<code>const</code>及引用限定符之后，而在<code>final</code>、<code>override</code>或虚函数<code>=0</code>之前。</p>
</li>
</ul>
<h3 id="4-1-违反异常说明">4.1 违反异常说明</h3>
<p>​编译器并不会在编译时检查<code>noexcept</code>说明。实际上，如果一个函数说明了<code>noexcept</code>的同时又含有<code>throw</code>语句或者调用了可能抛出异常的其他函数，编译器将顺利通过，并不会因为这种违反异常说明的情况而报错。</p>
<p>​因此可能会出现一种情况：尽管函数说明了它不会抛出异常，但实际上还是抛出了。一旦一个<code>noexcept</code>函数抛出异常，程序就会调用<code>terminate</code>以确保遵守不在运行时抛出异常的承诺。</p>
<p>​上述过程是执行栈展开未作约定，因此<code>noexcept</code>可以用在两种情况下：一是我们确认函数不会抛出异常，二是我们根本不知道该如何处理异常。</p>
<h3 id="4-2-noexcept运算符">4.2 noexcept运算符</h3>
<p>​<code>noexcept</code>说明符接受一个可选实参，该实参必须能转换为<code>bool</code>类型：如果实参是<code>true</code>，则函数不会抛出异常；如果实参是<code>false</code>，则函数可能抛出异常：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">recoup</span><span class="params">()</span> <span class="title">noexcept</span><span class="params">(<span class="literal">true</span>)</span></span>;	<span class="comment">/** 不会抛出异常 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">alloc</span><span class="params">()</span> <span class="title">noexcept</span><span class="params">(<span class="literal">false</span>)</span></span>;	<span class="comment">/** 可能抛出异常 */</span></span><br></pre></td></tr></table></figure>
<p>​<code>noexcept</code>说明符的实参常常与<code>noexcept</code>运算符混合使用。<code>noexcept</code>运算符是一个一元运算符，它的返回值是一个bool类型的右值常量表达式，用于表示给定的表达式是否会抛出异常。和<code>sizeof</code>类似，<code>noexcept</code>也不会求其运算对象的值。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">noexcept</span>(<span class="built_in">recoup</span>())	<span class="comment">/** 如果recoup不跑出异常则结果为true；否则结果为false */</span></span><br><span class="line"><span class="built_in">noexcept</span>(e)	<span class="comment">/** 等价于上一句 */</span></span><br></pre></td></tr></table></figure>
<p>我们可以使用noexcept运算符得到如下的异常说明：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">()</span> <span class="title">noexcept</span><span class="params">(<span class="keyword">noexcept</span>(g()))</span></span>;	<span class="comment">// f 和 g的异常说明一致</span></span><br></pre></td></tr></table></figure>
<p>如果函数<code>g()</code>承诺了不会抛出异常，则f也不会抛出异常；如果<code>g()</code>没有异常说明符，或者g虽然有异常说明符但是允许抛出异常，则<code>f()</code>也可能抛出异常。</p>
<blockquote>
<p><code>noexcept</code>有两层含义：当跟在函数参数列表后面时它是异常说明符；而当作为<code>noexcept</code>异常说明的<code>bool</code>实参出现时，它是一个运算符。</p>
</blockquote>
<h3 id="4-3-异常说明与指针、虚函数和拷贝控制">4.3 异常说明与指针、虚函数和拷贝控制</h3>
<p>​<strong>函数指针及该指针所指的函数必须具有一致的异常说明</strong>。也就是说我们为某个指针做了不抛出异常的声明，则该指针将只能指向不抛出异常的函数。相反，如果我们显式或隐式地说明了指针可能抛出异常，则该指针可以指向任何函数，即使是承诺了不抛出异常的函数也可以。</p>
<p>​如果<strong>虚函数</strong>承诺了它<strong>不会抛出异常</strong>，则后续派生出来的<strong>虚函数</strong>也必须做出<strong>同样的承诺</strong>；与之相反如果<strong>基类的虚函数允许抛出异常</strong>，则派<strong>生类的对应函数既可以允许抛出异常，也可以不允许抛出异常。</strong></p>
<p>​当编译器<strong>合成拷贝控制成员</strong>时，同时也<strong>生成一个异常说明</strong>。如果对<strong>所有成员</strong>和<strong>基类的所有操作</strong>都承诺了不会抛出异常，则合成的成员是<code>noexcept</code>的。如果合成成员调用的<strong>任意一个函数可能抛出异常</strong>，则合成的成员是<code>noexcept(false)</code>。而且如果我们定义了一个析构函数但是没有为它提供异常说明，则编译器将合成一个。合成的异常说明将于假设有编译器为类合成析构函数时所得的异常说明一致。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/07/04/2020-07-04-C++20%E4%B8%89%E8%B7%AF%E6%AF%94%E8%BE%83%E7%AC%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/04/2020-07-04-C++20%E4%B8%89%E8%B7%AF%E6%AF%94%E8%BE%83%E7%AC%A6/" class="post-title-link" itemprop="url">C++20三路比较符</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-04 11:05:05" itemprop="dateCreated datePublished" datetime="2020-07-04T11:05:05+08:00">2020-07-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-28 14:29:44" itemprop="dateModified" datetime="2023-10-28T14:29:44+08:00">2023-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1>三路比较符（C++20）</h1>
<p><a target="_blank" rel="noopener" href="https://zh.cppreference.com/w/cpp/utility/compare/compare_three_way">官网解释</a></p>
<p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/cppblog/simplify-your-code-with-rocket-science-c20s-spaceship-operator/">微软技术博客介绍</a></p>
<p><a target="_blank" rel="noopener" href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1186r3.html">When do you actually use <code>&lt;=&gt;</code>?</a></p>
<p>例子1：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;compare&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Rational_2</span> &#123;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    <span class="type">int</span> den; <span class="comment">// &gt; 0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> std::weak_ordering <span class="built_in">operator</span>&lt;=&gt;(Rational_2 lhs, Rational_2 rhs)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> lhs.num * rhs.den &lt;=&gt; rhs.num * lhs.den;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">(std::weak_ordering value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="number">0</span>)</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;equal\n&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (value &lt; <span class="number">0</span>)</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;less\n&quot;</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;greater\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Rational_2 c&#123;<span class="number">6</span>,<span class="number">5</span>&#125;;</span><br><span class="line">    Rational_2 d&#123;<span class="number">8</span>,<span class="number">7</span>&#125;;</span><br><span class="line">    <span class="built_in">print</span>(c &lt;=&gt; d);</span><br><span class="line">    <span class="built_in">print</span>(std::compare_three_way&#123;&#125;(c,d));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例子2：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;compare&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Basics</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="type">char</span> c;</span><br><span class="line">  <span class="type">float</span> f;</span><br><span class="line">  <span class="type">double</span> d;</span><br><span class="line">  <span class="keyword">auto</span> <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> Basics&amp;) <span class="type">const</span> = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Arrays</span> &#123;</span><br><span class="line">  <span class="type">int</span> ai[<span class="number">1</span>];</span><br><span class="line">  <span class="type">char</span> ac[<span class="number">2</span>];</span><br><span class="line">  <span class="type">float</span> af[<span class="number">3</span>];</span><br><span class="line">  <span class="type">double</span> ad[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">auto</span> <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> Arrays&amp;) <span class="type">const</span> = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Bases</span> : Basics, Arrays &#123;</span><br><span class="line">  <span class="keyword">auto</span> <span class="built_in">operator</span>&lt;=&gt;(<span class="type">const</span> Bases&amp;) <span class="type">const</span> = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constexpr</span> Bases a = &#123; &#123; <span class="number">0</span>, <span class="string">&#x27;c&#x27;</span>, <span class="number">1.f</span>, <span class="number">1.</span> &#125;,</span><br><span class="line">                        &#123; &#123; <span class="number">1</span> &#125;, &#123; <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span> &#125;, &#123; <span class="number">1.f</span>, <span class="number">2.f</span>, <span class="number">3.f</span> &#125;, &#123; &#123; <span class="number">1.</span>, <span class="number">2.</span> &#125;, &#123; <span class="number">3.</span>, <span class="number">4.</span> &#125; &#125; &#125; &#125;;</span><br><span class="line">  <span class="keyword">constexpr</span> Bases b = &#123; &#123; <span class="number">0</span>, <span class="string">&#x27;c&#x27;</span>, <span class="number">1.f</span>, <span class="number">1.</span> &#125;,</span><br><span class="line">                        &#123; &#123; <span class="number">1</span> &#125;, &#123; <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span> &#125;, &#123; <span class="number">1.f</span>, <span class="number">2.f</span>, <span class="number">3.f</span> &#125;, &#123; &#123; <span class="number">1.</span>, <span class="number">2.</span> &#125;, &#123; <span class="number">3.</span>, <span class="number">4.</span> &#125; &#125; &#125; &#125;;</span><br><span class="line">  <span class="built_in">static_assert</span>(a == b);</span><br><span class="line">  <span class="built_in">static_assert</span>(!(a != b));</span><br><span class="line">  <span class="built_in">static_assert</span>(!(a &lt; b));</span><br><span class="line">  <span class="built_in">static_assert</span>(a &lt;= b);</span><br><span class="line">  <span class="built_in">static_assert</span>(!(a &gt; b));</span><br><span class="line">  <span class="built_in">static_assert</span>(a &gt;= b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/07/04/2020-07-04-C++%E4%B8%A5%E6%A0%BC%E5%BC%B1%E5%BA%8F%E7%9A%84%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/04/2020-07-04-C++%E4%B8%A5%E6%A0%BC%E5%BC%B1%E5%BA%8F%E7%9A%84%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">C++严格弱序的介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-04 10:51:05" itemprop="dateCreated datePublished" datetime="2020-07-04T10:51:05+08:00">2020-07-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-28 14:29:44" itemprop="dateModified" datetime="2023-10-28T14:29:44+08:00">2023-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1>严格弱序（strict weak ordering）</h1>
<p>关联式容器（<code>set</code>、<code>multiset</code>、<code>map</code>和<code>multimap</code>）的排序准则的定义，和std::sort的排序准则定义必须遵守严格弱序，详细描述见官方解释(<a href="/resource/C++%E4%B8%A5%E6%A0%BC%E5%BC%B1%E5%BA%8F%E7%9A%84%E4%BB%8B%E7%BB%8D/strict_weak_ordering.pdf">strict weak ordering.pdf</a>)。</p>
<p><strong>严格弱序的定义</strong>：</p>
<p><strong>简单的来说就是a&lt;b返回true，a=b和a&gt;b返回false。</strong></p>
<p>详细定义：</p>
<blockquote>
<ol>
<li>
<p>必须是<strong>非对称的</strong>（antisymmetric）。</p>
<p>对<code>operator&lt; </code>而言， 如果x &lt; y为true， 则y &lt; x为false。</p>
<p>对判断式(predicate) <code>op()</code>而言，如果op(x, y)为true，则op(y, x)为false。</p>
</li>
<li>
<p>必须是<strong>可传递的</strong>（transitive）。</p>
</li>
</ol>
<p>对<code>operator&lt; </code>而言，如果x &lt; y 为true且y &lt; z为true， 则x &lt; z 为false。</p>
<p>对判断式(predicate) <code>op()</code>而言，如果op(x, y)为true且op(y, z)为tru，则op(x, z)为true。</p>
<ol start="3">
<li>
<p>必须是<strong>非自反的</strong>（irreflexive）</p>
<p>对<code>operator&lt; </code>而言，x &lt; x 永远是false</p>
<p>对判断式(predicate) <code>op()</code>而言，op(x, x)永远是false。</p>
</li>
<li>
<p>必须有<strong>等效传递性</strong>（transitivity of equivalence）</p>
</li>
</ol>
<p>对<code>operator&lt; </code>而言，假如 !(a&lt;b) &amp;&amp; !(b&lt;a) 为true且 !(b&lt;c) &amp;&amp; !(c&lt;b) 为 true<br>
那么!(a&lt;c) &amp;&amp; !(c&lt;a) 也为true.<br>
对判断式(predicate) <code>op()</code>而言， 假如 op(a,b), op(b,a), op(b,c), 和op(c,b) 都为<br>
false, 那么op(a,c) and op(c,a) 也为false.</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个定义std::set&lt;struct&gt;的例子</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ORDERING_EXAMPLE</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    <span class="type">int</span> z;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 重载遵循严格弱序的运算符&lt;</span></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span> &lt; (<span class="type">const</span> ORDERING_EXAMPLE&amp; OtherStruct) <span class="type">const</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;x &lt; OtherStruct.x)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (OtherStruct.x &lt; <span class="keyword">this</span>-&gt;x)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// x == x则比较y</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;y &lt; OtherStruct.y)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (OtherStruct.y &lt; <span class="keyword">this</span>-&gt;y)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// y == y则比较z</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;z &lt; OtherStruct.z)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::set&lt;ORDERING_EXAMPLE&gt; setOrderingExample;</span><br><span class="line"></span><br><span class="line">    ORDERING_EXAMPLE stOrderingExample0 = &#123; <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> &#125;;</span><br><span class="line">    ORDERING_EXAMPLE stOrderingExample1 = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span> &#125;;</span><br><span class="line">    ORDERING_EXAMPLE stOrderingExample2 = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span> &#125;;</span><br><span class="line">    ORDERING_EXAMPLE stOrderingExample3 = &#123; <span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span> &#125;;</span><br><span class="line"></span><br><span class="line">    setOrderingExample.<span class="built_in">insert</span>(stOrderingExample0);</span><br><span class="line">    setOrderingExample.<span class="built_in">insert</span>(stOrderingExample1);</span><br><span class="line">    setOrderingExample.<span class="built_in">insert</span>(stOrderingExample2);</span><br><span class="line">    setOrderingExample.<span class="built_in">insert</span>(stOrderingExample3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面举一个会崩溃的例子对二维数组排序。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">temp</span><span class="params">(<span class="number">5</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line">  std::vector&lt;std::vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">vec</span>(<span class="number">5</span>, temp);</span><br><span class="line">  std::<span class="built_in">sort</span>(vec.<span class="built_in">begin</span>(), vec.<span class="built_in">end</span>(),</span><br><span class="line">            [](<span class="type">const</span> std::vector&lt;<span class="type">int</span>&gt; &amp;l, <span class="type">const</span> std::vector&lt;<span class="type">int</span>&gt; &amp;r) &#123;</span><br><span class="line">              <span class="keyword">if</span> (l.<span class="built_in">size</span>() == r.<span class="built_in">size</span>()) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; l.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (l.<span class="built_in">at</span>(i) == r.<span class="built_in">at</span>(i)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> l.<span class="built_in">at</span>(i) &lt; r.<span class="built_in">at</span>(i);</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;  <span class="comment">/// 这里会崩溃，改为false则不会而不会崩溃(遵循严格弱序)</span></span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> l.<span class="built_in">size</span>() &lt; r.<span class="built_in">size</span>();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个参数的重载符号简单示例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">key</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>&lt;(<span class="type">const</span> key&amp; stOther)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; stOther.x)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; stOther.x)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (y &lt; stOther.y)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (y &gt; stOther.y)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">key</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    std::string y;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>&lt;(<span class="type">const</span> key&amp; stOther)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; stOther.x)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; stOther.x)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (y &lt; stOther.y)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (y &gt; stOther.y)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/07/03/2020-07-03-C++%E5%85%B3%E4%BA%8E%E4%B9%98%E6%B3%95%E6%BA%A2%E5%87%BA%E7%9A%84%E5%88%A4%E6%96%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/03/2020-07-03-C++%E5%85%B3%E4%BA%8E%E4%B9%98%E6%B3%95%E6%BA%A2%E5%87%BA%E7%9A%84%E5%88%A4%E6%96%AD/" class="post-title-link" itemprop="url">C++关于乘法溢出的判断</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-03 21:22:47" itemprop="dateCreated datePublished" datetime="2020-07-03T21:22:47+08:00">2020-07-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-28 14:29:44" itemprop="dateModified" datetime="2023-10-28T14:29:44+08:00">2023-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="概述">概述</h2>
<p>首先我们对于乘法溢出的判断，先写测试用例：</p>
<p><img src="/resource/%E5%85%B3%E4%BA%8E%E4%B9%98%E6%B3%95%E6%BA%A2%E5%87%BA%E7%9A%84%E5%88%A4%E6%96%AD/1592715337389.png" alt="1592715337389"></p>
<p>由上图我们简化测试用例：</p>
<p><img src="/resource/%E5%85%B3%E4%BA%8E%E4%B9%98%E6%B3%95%E6%BA%A2%E5%87%BA%E7%9A%84%E5%88%A4%E6%96%AD/1592715602260.png" alt="1592715602260"></p>
<p>我们可以这样设计乘法溢出函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 判断两入参相乘是否溢出，溢出返回true，否则返回false</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_multi_overflow</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/// 同为正号</span></span><br><span class="line">      <span class="keyword">return</span> x &gt; INT_MAX/y;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/// 同为负号</span></span><br><span class="line">    <span class="keyword">if</span> (y == INT_MIN &amp;&amp; x &lt;= <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x &lt; INT_MIN/-y;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y&lt;<span class="number">0</span> || (x &lt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="comment">/// 异号的情况稍等补上</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们添加测试用例</p>
<p><img src="/resource/%E5%85%B3%E4%BA%8E%E4%B9%98%E6%B3%95%E6%BA%A2%E5%87%BA%E7%9A%84%E5%88%A4%E6%96%AD/1592727579022.png" alt="1592727579022"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;numeric&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 判断两入参相乘是否溢出，溢出返回true，否则返回false</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_multi_overflow</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/// 同为正号</span></span><br><span class="line">      <span class="keyword">return</span> x &gt; INT_MAX/y;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/// 同为负号</span></span><br><span class="line">    <span class="keyword">if</span> (y == INT_MIN &amp;&amp; x &lt;= <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x &lt; INT_MIN/-y;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y&lt;<span class="number">0</span> || (x &lt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="comment">/// 异号的情况稍等补上</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> y = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> max_num = std::numeric_limits&lt;<span class="type">int</span>&gt;::<span class="built_in">max</span>();</span><br><span class="line">  <span class="type">int</span> min_num = std::numeric_limits&lt;<span class="type">int</span>&gt;::<span class="built_in">min</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 1 #1</span></span><br><span class="line">  x = <span class="number">7</span>;</span><br><span class="line">  y = <span class="number">1</span> + max_num / x;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = max_num - <span class="number">1</span>;</span><br><span class="line">  y = <span class="number">1</span> + max_num / x;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 1 #2</span></span><br><span class="line">  x = <span class="number">7</span>;</span><br><span class="line">  y = max_num / x;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = max_num - <span class="number">1</span>;</span><br><span class="line">  y = max_num / x;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 2 #1</span></span><br><span class="line">  x = <span class="number">-7</span>;</span><br><span class="line">  y = <span class="number">-1</span> + min_num / -x;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = min_num + <span class="number">1</span>;</span><br><span class="line">  y = <span class="number">-1</span> + min_num / -x;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 2 #2</span></span><br><span class="line">  x = <span class="number">-7</span>;</span><br><span class="line">  y = min_num / -x;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = min_num + <span class="number">1</span>;</span><br><span class="line">  y = min_num / -x;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来为特殊数值来添加判断：</p>
<p><img src="/resource/%E5%85%B3%E4%BA%8E%E4%B9%98%E6%B3%95%E6%BA%A2%E5%87%BA%E7%9A%84%E5%88%A4%E6%96%AD/1592727736048.png" alt="1592727736048"></p>
<p>添加异号情况的判断：</p>
<p><img src="/resource/%E5%85%B3%E4%BA%8E%E4%B9%98%E6%B3%95%E6%BA%A2%E5%87%BA%E7%9A%84%E5%88%A4%E6%96%AD/1592730284047.png" alt="1592730284047"></p>
<p>把函数改为模板，一并添加测试用例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;numeric&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 判断两入参相乘是否溢出，溢出返回true，否则返回false</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T1, <span class="keyword">typename</span> T2&gt;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_multi_overflow</span><span class="params">(T1 x, T2 y)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">static_assert</span>(std::is_same&lt;T1, T2&gt;::value,</span><br><span class="line">                <span class="string">&quot;is_multi_overflow need same type!&quot;</span>);</span><br><span class="line">  <span class="built_in">static_assert</span>(std::is_integral&lt;T1&gt;::value,</span><br><span class="line">                <span class="string">&quot; is_multi_overflow need integral type!&quot;</span>);</span><br><span class="line">  <span class="type">int</span> num_max = std::numeric_limits&lt;T1&gt;::<span class="built_in">max</span>();</span><br><span class="line">  <span class="type">int</span> num_min = std::numeric_limits&lt;T1&gt;::<span class="built_in">min</span>();</span><br><span class="line">  <span class="keyword">if</span> (x == <span class="number">0</span> || y == <span class="number">0</span> || x == <span class="number">1</span> || y == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (x == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> y == num_min;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x == num_min;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/// 同为正号</span></span><br><span class="line">    <span class="keyword">return</span> x &gt; num_max / y;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &lt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">/// 同为负号</span></span><br><span class="line">    <span class="keyword">if</span> (y == num_min &amp;&amp; x &lt;= <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x &lt; num_min / -y;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span> || (x &lt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="comment">/// 异号的情况</span></span><br><span class="line">    <span class="keyword">if</span> (x &gt; y) &#123;</span><br><span class="line">      std::<span class="built_in">swap</span>(x, y);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x &lt; num_min / y;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> y = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> max_num = std::numeric_limits&lt;<span class="type">int</span>&gt;::<span class="built_in">max</span>();</span><br><span class="line">  <span class="type">int</span> min_num = std::numeric_limits&lt;<span class="type">int</span>&gt;::<span class="built_in">min</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 1 #1</span></span><br><span class="line">  x = <span class="number">7</span>;</span><br><span class="line">  y = <span class="number">1</span> + max_num / x;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = max_num - <span class="number">1</span>;</span><br><span class="line">  y = <span class="number">1</span> + max_num / x;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 1 #2</span></span><br><span class="line">  x = <span class="number">7</span>;</span><br><span class="line">  y = max_num / x;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = max_num - <span class="number">1</span>;</span><br><span class="line">  y = max_num / x;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 2 #1</span></span><br><span class="line">  x = <span class="number">-7</span>;</span><br><span class="line">  y = <span class="number">-1</span> + min_num / -x;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = min_num + <span class="number">1</span>;</span><br><span class="line">  y = <span class="number">-1</span> + min_num / -x;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 2 #2</span></span><br><span class="line">  x = <span class="number">-7</span>;</span><br><span class="line">  y = min_num / -x;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = min_num + <span class="number">1</span>;</span><br><span class="line">  y = min_num / -x;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 3</span></span><br><span class="line">  x = <span class="number">0</span>;</span><br><span class="line">  y = max_num;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = min_num;</span><br><span class="line">  y = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = <span class="number">0</span>;</span><br><span class="line">  y = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 4</span></span><br><span class="line">  x = <span class="number">1</span>;</span><br><span class="line">  y = max_num;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = INT_MIN;</span><br><span class="line">  y = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 5</span></span><br><span class="line">  x = <span class="number">-1</span>;</span><br><span class="line">  y = max_num;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  x = <span class="number">-1</span>;</span><br><span class="line">  y = min_num;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// case 6</span></span><br><span class="line">  x = <span class="number">2</span>;</span><br><span class="line">  y = min_num / <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  <span class="built_in">assert</span>(!<span class="built_in">is_multi_overflow</span>(y, x));</span><br><span class="line">  x = <span class="number">2</span>;</span><br><span class="line">  y = <span class="number">-1</span> + min_num / <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(x, y));</span><br><span class="line">  <span class="built_in">assert</span>(<span class="built_in">is_multi_overflow</span>(y, x));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后附上完整测试用例：</p>
<p><img src="/resource/%E5%85%B3%E4%BA%8E%E4%B9%98%E6%B3%95%E6%BA%A2%E5%87%BA%E7%9A%84%E5%88%A4%E6%96%AD/1592730393076.png" alt="1592730393076"></p>
<h2 id="后记">后记</h2>
<p>我们既然有了判断乘法溢出的函数，我们可以借此封装一个带有检查溢出的乘法函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;optional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T1, <span class="keyword">typename</span> T2&gt;</span><br><span class="line"><span class="function">std::optional&lt;T1&gt; <span class="title">multiplies_s</span><span class="params">(<span class="type">const</span> T1 x, <span class="type">const</span> T2 y)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">  <span class="built_in">static_assert</span>(std::is_same&lt;T1, T2&gt;::value, <span class="string">&quot;Multiplies_s need same type!&quot;</span>);</span><br><span class="line">  <span class="built_in">static_assert</span>(std::is_integral&lt;T1&gt;::value,</span><br><span class="line">                <span class="string">&quot;Multiplies_s need integral type!&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">is_multi_overflow</span>(x, y)) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> x * y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> x = <span class="number">5</span>;</span><br><span class="line">  <span class="type">int</span> y = <span class="number">5</span>;</span><br><span class="line">  <span class="type">int</span> result = <span class="built_in">multiplies_s</span>(x, y).<span class="built_in">value_or</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/07/03/2020-07-03-C++%E5%85%B3%E4%BA%8E%E8%99%9A%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/03/2020-07-03-C++%E5%85%B3%E4%BA%8E%E8%99%9A%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">C++关于虚析构函数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-03 20:21:05" itemprop="dateCreated datePublished" datetime="2020-07-03T20:21:05+08:00">2020-07-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-28 14:29:44" itemprop="dateModified" datetime="2023-10-28T14:29:44+08:00">2023-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="虚析构函数问题">虚析构函数问题</h2>
<blockquote>
<p>引用标准中原文：  一条有用的方针，是任何基类的析构函数必须为公开且虚， 或受保护且非虚。</p>
</blockquote>
<p>虚析构这个概念被设计出来就是<strong>为了解决基类指针指向派生类实例的析构问题</strong>，当一个基类指针指向派生类实例然后进行delete该指针时，只会执行基类析构函数而派生类的析构函数不会被执行，这将导致派生类构造的资源不会被正确释放，造成内存泄漏。如下示例：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line">     <span class="built_in">Base</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;Base Construct!&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">     <span class="comment">/// 该析构函数为错误示例，严禁这样写.</span></span><br><span class="line">     ~<span class="built_in">Base</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;Base Deconstruct!&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">Derived</span>()   &#123; std::cout &lt;&lt; <span class="string">&quot;Derived Construct!&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">    ~<span class="built_in">Derived</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;Derived Deconstruct!&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/** 使用基类指针指向派生类实例 */</span></span><br><span class="line">        Base* BasePtr = <span class="keyword">new</span> Derived;</span><br><span class="line">        <span class="keyword">delete</span> BasePtr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="/resource/%E5%85%B3%E4%BA%8E%E8%99%9A%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0/Virtual_DeConstruct_Debug.png" alt="Virtual DeConstruct Debug"></p>
<p>可以看到派生类没有被析构，如要解决该问题在基类析构函数处加上<strong>virtual</strong>关键字即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line">     <span class="built_in">Base</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;Base Construct!&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">     <span class="comment">/** 正确写法： 加上关键字virtual， 后面函数体可写可不写，或者直接使用=default都行。 */</span></span><br><span class="line">     <span class="keyword">virtual</span> ~<span class="built_in">Base</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;Base Deconstruct!&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">Derived</span>()   &#123; std::cout &lt;&lt; <span class="string">&quot;Derived Construct!&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">    ~<span class="built_in">Derived</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;Derived Deconstruct!&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line">    <span class="comment">/// 或者 virtual ~Derived() override &#123;&#125;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/** 使用基类指针指向派生类实例 */</span></span><br><span class="line">        Base* BasePtr = <span class="keyword">new</span> Derived;</span><br><span class="line">        <span class="keyword">delete</span> BasePtr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<p><img src="/resource/%E5%85%B3%E4%BA%8E%E8%99%9A%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0/Virtual_DeConstruct_Debug_Correct.png" alt="Virtual DeConstruct Debug Correct"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/07/02/2020-07-02-PlantUML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/02/2020-07-02-PlantUML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">PlantUML语法学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-02 19:54:47" itemprop="dateCreated datePublished" datetime="2020-07-02T19:54:47+08:00">2020-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-28 14:29:44" itemprop="dateModified" datetime="2023-10-28T14:29:44+08:00">2023-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UML/" itemprop="url" rel="index"><span itemprop="name">UML</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1>PlantUML语法学习</h1>
<h2 id="类图">类图</h2>
<h3 id="类之间的关系">类之间的关系</h3>
<p>类之间的关系通过下面的符号定义:</p>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/Snipaste_2020-06-27_20-38-31.png" alt="类之间的关系"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">Class01 &lt;|-- Class02</span><br><span class="line">Class03 *-- Class04</span><br><span class="line">Class05 o-- Class06</span><br><span class="line">Class07 .. Class08</span><br><span class="line">Class09 -- Class10</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_1.png" alt="class1"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">Class11 &lt;|.. Class12</span><br><span class="line">Class13 --&gt; Class14</span><br><span class="line">Class15 ..&gt; Class16</span><br><span class="line">Class17 ..|&gt; Class18</span><br><span class="line">Class19 &lt;--* Class20</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_2.png" alt="class2"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">Class21 #-- Class22</span><br><span class="line">Class23 x-- Class24</span><br><span class="line">Class25 &#125;-- Class26</span><br><span class="line">Class27 +-- Class28</span><br><span class="line">Class29 ^-- Class30</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_3.png" alt="class3"></p>
<h3 id="关系上的标识">关系上的标识</h3>
<p>在关系之间使用标签来说明时, 使用: 后接标签文字。<br>
对元素的说明，你可以在每一边使用&quot;&quot; 来说明.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">Class01 &quot;1&quot; *-- &quot;many&quot; Class02 : contains</span><br><span class="line">Class03 o-- Class04 : aggregation</span><br><span class="line">Class05 --&gt; &quot;1&quot; Class06</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_4.png" alt="class4"></p>
<p>在标签的开始或结束位置添加&lt; 或&gt; 以表明是哪个对象作用到哪个对象上。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">class Car</span><br><span class="line">Driver - Car : drives &gt;</span><br><span class="line">Car *- Wheel : have 4 &gt;</span><br><span class="line">Car -- Person : &lt; owns</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_5.png" alt="class5"></p>
<h3 id="添加方法">添加方法</h3>
<p>为了声明字段(对象属性）或者方法，你可以使用后接字段名或方法名。<br>
系统检查是否有括号来判断是方法还是字段。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">Object &lt;|-- ArrayList</span><br><span class="line">Object : equals()</span><br><span class="line">ArrayList : Object[] elementData</span><br><span class="line">ArrayList : size()</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_6.png" alt="class6"></p>
<p>也可以使用{} 把字段或者方法括起来<br>
注意，这种语法对于类型/名字的顺序是非常灵活的。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">class Dummy &#123;</span><br><span class="line">String data</span><br><span class="line">void methods()</span><br><span class="line">&#125;</span><br><span class="line">class Flight &#123;</span><br><span class="line">flightNumber : Integer</span><br><span class="line">departureTime : Date</span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_7.png" alt="class7"></p>
<p>你可以（显式地）使用{field} 和{method} 修饰符来覆盖解析器的对于字段和方法的默认行为</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">class Dummy &#123;</span><br><span class="line">&#123;field&#125; A field (despite parentheses)</span><br><span class="line">&#123;method&#125; Some method</span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_8.png" alt="class8"></p>
<h3 id="定义可访问性">定义可访问性</h3>
<p>一旦你定义了域或者方法，你可以定义相应条目的可访问性质。<br>
<img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/Snipaste_2020-06-27_20-55-15.png" alt="定义可访问性"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">class Dummy &#123;</span><br><span class="line">-field1</span><br><span class="line">#field2</span><br><span class="line">~method1()</span><br><span class="line">+method2()</span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_9.png" alt="class9"></p>
<p>你可以采用命令（skinparam classAttributeIconSize 0 ：)停用该特性</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">skinparam classAttributeIconSize 0</span><br><span class="line">class Dummy &#123;</span><br><span class="line">-field1</span><br><span class="line">#field2</span><br><span class="line">~method1()</span><br><span class="line">+method2()</span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_10.png" alt="class10"></p>
<h3 id="抽象与静态">抽象与静态</h3>
<p>通过修饰符{static} 或者{abstract}，可以定义静态或者抽象的方法或者属性。<br>
这些修饰符可以写在行的开始或者结束。也可以使用{classifier} 这个修饰符来代替{static}.</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">class Dummy &#123;</span><br><span class="line">&#123;static&#125; String id</span><br><span class="line">&#123;abstract&#125; void methods()</span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_11.png" alt="class11"></p>
<h3 id="高级类体">高级类体</h3>
<p>PlantUML 默认自动将方法和属性重新分组，你可以自己定义分隔符来重排方法和属性，下面的分隔符都<br>
是可用的：-- … == __.<br>
还可以在分隔符中添加标题</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">class Foo1 &#123;</span><br><span class="line">You can use</span><br><span class="line">several lines</span><br><span class="line">..</span><br><span class="line">as you want</span><br><span class="line">and group</span><br><span class="line">==</span><br><span class="line">things together.</span><br><span class="line">__</span><br><span class="line">You can have as many groups</span><br><span class="line">as you want</span><br><span class="line">--</span><br><span class="line">End of class</span><br><span class="line">&#125;</span><br><span class="line">class User &#123;</span><br><span class="line">.. Simple Getter ..</span><br><span class="line">+ getName()</span><br><span class="line">+ getAddress()</span><br><span class="line">.. Some setter ..</span><br><span class="line">+ setName()</span><br><span class="line">__ private data __</span><br><span class="line">int age</span><br><span class="line">-- encrypted --</span><br><span class="line">String password</span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_12.png" alt="class12"></p>
<h3 id="更多注释">更多注释</h3>
<p>可以在注释中使用部分html 标签：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">class Foo</span><br><span class="line">note left: On last defined class</span><br><span class="line">note top of Object</span><br><span class="line">In java, &lt;size:18&gt;every&lt;/size&gt; &lt;u&gt;class&lt;/u&gt;</span><br><span class="line">&lt;b&gt;extends&lt;/b&gt;</span><br><span class="line">&lt;i&gt;this&lt;/i&gt; one.</span><br><span class="line">end note</span><br><span class="line">note as N1</span><br><span class="line">This note is &lt;u&gt;also&lt;/u&gt;</span><br><span class="line">&lt;b&gt;&lt;color:royalBlue&gt;on several&lt;/color&gt;</span><br><span class="line">&lt;s&gt;words&lt;/s&gt; lines</span><br><span class="line">And this is hosted by &lt;img:sourceforge.jpg&gt;</span><br><span class="line">end note</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/class_uml_13.png" alt="class13"></p>
<h2 id="对象图">对象图</h2>
<h3 id="对象的定义">对象的定义</h3>
<p>使用关键字object 定义实例。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">object firstObject</span><br><span class="line">object &quot;My Second Object&quot; as o2</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p>如下图生成：</p>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/object_uml_1.png" alt="object1"></p>
<h3 id="对象之间的关系">对象之间的关系</h3>
<p>对象之间的关系可以用如下符号定义：</p>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/Snipaste_2020-06-27_19-56-04.png" alt="对象之间的关系"></p>
<p>也可以用… 来代替-- 以使用点线。<br>
知道了这些规则，就可以画下面的图：<br>
可以用冒号给关系添加标签，标签内容紧跟在冒号之后。<br>
用双引号在关系的两边添加基数。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">object Object01</span><br><span class="line">object Object02</span><br><span class="line">object Object03</span><br><span class="line">object Object04</span><br><span class="line">object Object05</span><br><span class="line">object Object06</span><br><span class="line">object Object07</span><br><span class="line">object Object08</span><br><span class="line">Object01 &lt;|-- Object02</span><br><span class="line">Object03 *-- Object04</span><br><span class="line">Object05 o-- &quot;4&quot; Object06</span><br><span class="line">Object07 .. Object08 : some labels</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p>如下图生成：</p>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/object_uml_2.png" alt="object2"></p>
<h3 id="添加属性">添加属性</h3>
<p>用冒号加属性名的形式声明属性。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">object user</span><br><span class="line">user : name = &quot;Dummy&quot;</span><br><span class="line">user : id = 123</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p>如下图生成：</p>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/object_uml_3.png" alt="object3"></p>
<h2 id="活动图">活动图</h2>
<h3 id="简单活动">简单活动</h3>
<p>使用(*) 作为活动图的开始点和结束点。<br>
有时，你可能想用(*top) 强制开始点位于图示的顶端。<br>
使用–&gt; 绘制箭头。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">(*) --&gt; &quot;First Activity&quot;</span><br><span class="line">&quot;First Activity&quot; --&gt; (*)</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/activity_uml_1.png" alt="activity1"></p>
<h3 id="箭头上的标签">箭头上的标签</h3>
<p>默认情况下，箭头开始于最接近的活动。<br>
可以用[ 和 ] 放在箭头定义的后面来添加标签。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">(*) --&gt; &quot;First Activity&quot;</span><br><span class="line">--&gt;[You can put also labels] &quot;Second Activity&quot;</span><br><span class="line">--&gt; (*)</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/activity_uml_2.png" alt="activity2"></p>
<h3 id="改变箭头方向">改变箭头方向</h3>
<p>你可以使用-&gt; 定义水平方向箭头，还可以使用下列语法强制指定箭头的方向：</p>
<ul>
<li>-down-&gt; (default arrow)</li>
<li>-right-&gt; or -&gt;</li>
<li>-left-&gt;</li>
<li>-up-&gt;</li>
</ul>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/activity_uml_3.png" alt="activity3"></p>
<h3 id="分支">分支</h3>
<p>你可以使用关键字if/then/else 创建分支。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">(*) --&gt; &quot;Initialization&quot;</span><br><span class="line">if &quot;Some Test&quot; then</span><br><span class="line">--&gt;[true] &quot;Some Activity&quot;</span><br><span class="line">--&gt; &quot;Another activity&quot;</span><br><span class="line">-right-&gt; (*)</span><br><span class="line">else</span><br><span class="line">-&gt;[false] &quot;Something else&quot;</span><br><span class="line">--&gt;[Ending process] (*)</span><br><span class="line">endif</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/activity_uml_4.png" alt="activity4"></p>
<p>不过，有时你可能需要重复定义同一个活动：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">(*) --&gt; &quot;check input&quot;</span><br><span class="line">If &quot;input is verbose&quot; then</span><br><span class="line">--&gt; [Yes] &quot;turn on verbosity&quot;</span><br><span class="line">--&gt; &quot;run command&quot;</span><br><span class="line">else</span><br><span class="line">--&gt; &quot;run command&quot;</span><br><span class="line">Endif</span><br><span class="line">--&gt;(*)</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/activity_uml_5.png" alt="activity5"></p>
<h3 id="更多分支">更多分支</h3>
<p>默认情况下，一个分支连接上一个最新的活动，但是也可以使用if 关键字进行连接。<br>
还可以嵌套定义分支。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">(*) --&gt; if &quot;Some Test&quot; then</span><br><span class="line">--&gt;[true] &quot;activity 1&quot;</span><br><span class="line">if &quot;&quot; then</span><br><span class="line">-&gt; &quot;activity 3&quot; as a3</span><br><span class="line">else</span><br><span class="line">if &quot;Other test&quot; then</span><br><span class="line">-left-&gt; &quot;activity 5&quot;</span><br><span class="line">else</span><br><span class="line">--&gt; &quot;activity 6&quot;</span><br><span class="line">endif</span><br><span class="line">endif</span><br><span class="line">else</span><br><span class="line">-&gt;[false] &quot;activity 2&quot;</span><br><span class="line">endif</span><br><span class="line">a3 --&gt; if &quot;last test&quot; then</span><br><span class="line">--&gt; &quot;activity 7&quot;</span><br><span class="line">else</span><br><span class="line">-&gt; &quot;activity 8&quot;</span><br><span class="line">endif</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/activity_uml_6.png" alt="activity6"></p>
<h3 id="注释">注释</h3>
<p>你可以在活动定义之后用note left, note right, note top or note bottom, 命令给活动添加注释。<br>
如果想给开始点添加注释，只需把注释的定义放在活动图最开始的地方即可。<br>
也可以用关键字endnote 定义多行注释。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">(*) --&gt; &quot;Some Activity&quot;</span><br><span class="line">note right: This activity has to be defined</span><br><span class="line">&quot;Some Activity&quot; --&gt; (*)</span><br><span class="line">note left</span><br><span class="line">This note is on</span><br><span class="line">several lines</span><br><span class="line">end note</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/activity_uml_7.png" alt="activity7"></p>
<h3 id="分区">分区</h3>
<p>用关键字partition 定义分区，还可以设置背景色(用颜色名或者颜色值)。<br>
定义活动的时候，它自动被放置到最新的分区中。<br>
用} 结束分区的定义。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">partition Conductor &#123;</span><br><span class="line">(*) --&gt; &quot;Climbs on Platform&quot;</span><br><span class="line">--&gt; === S1 ===</span><br><span class="line">--&gt; Bows</span><br><span class="line">&#125;</span><br><span class="line">partition Audience #LightSkyBlue &#123;</span><br><span class="line">=== S1 === --&gt; Applauds</span><br><span class="line">&#125;</span><br><span class="line">partition Conductor &#123;</span><br><span class="line">Bows --&gt; === S2 ===</span><br><span class="line">--&gt; WavesArmes</span><br><span class="line">Applauds --&gt; === S2 ===</span><br><span class="line">&#125;</span><br><span class="line">partition Orchestra #CCCCEE &#123;</span><br><span class="line">WavesArmes --&gt; Introduction</span><br><span class="line">--&gt; &quot;Play music&quot;</span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/activity_uml_8.png" alt="activity8"></p>
<h3 id="一个完整的例子">一个完整的例子</h3>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title Servlet Container</span><br><span class="line">(*) --&gt; &quot;ClickServlet.handleRequest()&quot;</span><br><span class="line">--&gt; &quot;new Page&quot;</span><br><span class="line">if &quot;Page.onSecurityCheck&quot; then</span><br><span class="line">-&gt;[true] &quot;Page.onInit()&quot;</span><br><span class="line">if &quot;isForward?&quot; then</span><br><span class="line">-&gt;[no] &quot;Process controls&quot;</span><br><span class="line">if &quot;continue processing?&quot; then</span><br><span class="line">--&gt;[yes] ===RENDERING===</span><br><span class="line">else</span><br><span class="line">--&gt;[no] ===REDIRECT_CHECK===</span><br><span class="line">endif</span><br><span class="line">else</span><br><span class="line">--&gt;[yes] ===RENDERING===</span><br><span class="line">endif</span><br><span class="line">if &quot;is Post?&quot; then</span><br><span class="line">--&gt;[yes] &quot;Page.onPost()&quot;</span><br><span class="line">--&gt; &quot;Page.onRender()&quot; as render</span><br><span class="line">--&gt; ===REDIRECT_CHECK===</span><br><span class="line">else</span><br><span class="line">--&gt;[no] &quot;Page.onGet()&quot;</span><br><span class="line">--&gt; render</span><br><span class="line">endif</span><br><span class="line">else</span><br><span class="line">--&gt;[false] ===REDIRECT_CHECK===</span><br><span class="line">endif</span><br><span class="line">if &quot;Do redirect?&quot; then</span><br><span class="line">-&gt;[yes] &quot;redirect request&quot;</span><br><span class="line">--&gt; ==BEFORE_DESTROY===</span><br><span class="line">else</span><br><span class="line">if &quot;Do Forward?&quot; then</span><br><span class="line">-left-&gt;[yes] &quot;Forward request&quot;</span><br><span class="line">--&gt; ==BEFORE_DESTROY===</span><br><span class="line">else</span><br><span class="line">-right-&gt;[no] &quot;Render page template&quot;</span><br><span class="line">--&gt; ==BEFORE_DESTROY===</span><br><span class="line">endif</span><br><span class="line">endif</span><br><span class="line">--&gt; &quot;Page.onDestroy()&quot;</span><br><span class="line">--&gt;(*)</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/activity_uml_9.png" alt="activity9"></p>
<h3 id="界面格式相关">界面格式相关</h3>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">skinparam SequenceGroupBodyBackgroundColor #FFFFFF90</span><br><span class="line"></span><br><span class="line">box &quot;Internal Service&quot; #LightBlue</span><br><span class="line">    participant Bob</span><br><span class="line">    participant Alice</span><br><span class="line">end box</span><br><span class="line"></span><br><span class="line">box &quot;Other&quot; #LightGreen</span><br><span class="line">    participant Other</span><br><span class="line">end box</span><br><span class="line"></span><br><span class="line">group group</span><br><span class="line">    Bob -&gt; Alice : hello</span><br><span class="line">    Alice -&gt; Other : hello</span><br><span class="line">end</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/skinparam_uml_0.png" alt="skinparam_uml_0"></p>
<h3 id="颜色示例">颜色示例</h3>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line"></span><br><span class="line">!unquoted procedure $DrawColor($colour)</span><br><span class="line"></span><br><span class="line">    skinparam rectangle &#123;</span><br><span class="line">            backgroundColor&lt;&lt;$colour&gt;&gt; $colour</span><br><span class="line">            borderColor&lt;&lt;$colour&gt;&gt; $colour</span><br><span class="line">            shadowing&lt;&lt;$colour&gt;&gt; true</span><br><span class="line">            BorderThickness&lt;&lt;$colour&gt;&gt; 1</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    rectangle $colour &lt;&lt;$colour&gt;&gt; as &quot;&lt;color:$colour&gt;&lt;/color&gt;&quot;</span><br><span class="line"></span><br><span class="line">!endprocedure</span><br><span class="line"></span><br><span class="line">package HexCodes &#123;</span><br><span class="line">$DrawColor(&quot;00ff00&quot;)</span><br><span class="line">$DrawColor(&quot;ff0000&quot;)</span><br><span class="line">$DrawColor(&quot;0000ff&quot;)</span><br><span class="line">$DrawColor(&quot;123456&quot;)</span><br><span class="line">$DrawColor(&quot;654321&quot;)</span><br><span class="line">$DrawColor(&quot;165432&quot;)</span><br><span class="line">$DrawColor(&quot;ff22ff&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">package Colours &#123;</span><br><span class="line">$DrawColor(&quot;APPLICATION&quot;)</span><br><span class="line">$DrawColor(&quot;AliceBlue&quot;)</span><br><span class="line">$DrawColor(&quot;AntiqueWhite&quot;)</span><br><span class="line">$DrawColor(&quot;Aqua&quot;)</span><br><span class="line">$DrawColor(&quot;Aquamarine&quot;)</span><br><span class="line">$DrawColor(&quot;Azure&quot;)</span><br><span class="line">$DrawColor(&quot;BUSINESS&quot;)</span><br><span class="line">$DrawColor(&quot;Beige&quot;)</span><br><span class="line">$DrawColor(&quot;Bisque&quot;)</span><br><span class="line">$DrawColor(&quot;Black&quot;)</span><br><span class="line">$DrawColor(&quot;BlanchedAlmond&quot;)</span><br><span class="line">$DrawColor(&quot;Blue&quot;)</span><br><span class="line">$DrawColor(&quot;BlueViolet&quot;)</span><br><span class="line">$DrawColor(&quot;Brown&quot;)</span><br><span class="line">$DrawColor(&quot;BurlyWood&quot;)</span><br><span class="line">$DrawColor(&quot;CadetBlue&quot;)</span><br><span class="line">$DrawColor(&quot;Chartreuse&quot;)</span><br><span class="line">$DrawColor(&quot;Chocolate&quot;)</span><br><span class="line">$DrawColor(&quot;Coral&quot;)</span><br><span class="line">$DrawColor(&quot;CornflowerBlue&quot;)</span><br><span class="line">$DrawColor(&quot;Cornsilk&quot;)</span><br><span class="line">$DrawColor(&quot;Crimson&quot;)</span><br><span class="line">$DrawColor(&quot;Cyan&quot;)</span><br><span class="line">$DrawColor(&quot;DarkBlue&quot;)</span><br><span class="line">$DrawColor(&quot;DarkCyan&quot;)</span><br><span class="line">$DrawColor(&quot;DarkGoldenRod&quot;)</span><br><span class="line">$DrawColor(&quot;DarkGray&quot;)</span><br><span class="line">$DrawColor(&quot;DarkGreen&quot;)</span><br><span class="line">$DrawColor(&quot;DarkGrey&quot;)</span><br><span class="line">$DrawColor(&quot;DarkKhaki&quot;)</span><br><span class="line">$DrawColor(&quot;DarkMagenta&quot;)</span><br><span class="line">$DrawColor(&quot;DarkOliveGreen&quot;)</span><br><span class="line">$DrawColor(&quot;DarkOrchid&quot;)</span><br><span class="line">$DrawColor(&quot;DarkRed&quot;)</span><br><span class="line">$DrawColor(&quot;DarkSalmon&quot;)</span><br><span class="line">$DrawColor(&quot;DarkSeaGreen&quot;)</span><br><span class="line">$DrawColor(&quot;DarkSlateBlue&quot;)</span><br><span class="line">$DrawColor(&quot;DarkSlateGray&quot;)</span><br><span class="line">$DrawColor(&quot;DarkSlateGrey&quot;)</span><br><span class="line">$DrawColor(&quot;DarkTurquoise&quot;)</span><br><span class="line">$DrawColor(&quot;DarkViolet&quot;)</span><br><span class="line">$DrawColor(&quot;Darkorange&quot;)</span><br><span class="line">$DrawColor(&quot;DeepPink&quot;)</span><br><span class="line">$DrawColor(&quot;DeepSkyBlue&quot;)</span><br><span class="line">$DrawColor(&quot;DimGray&quot;)</span><br><span class="line">$DrawColor(&quot;DimGrey&quot;)</span><br><span class="line">$DrawColor(&quot;DodgerBlue&quot;)</span><br><span class="line">$DrawColor(&quot;FireBrick&quot;)</span><br><span class="line">$DrawColor(&quot;FloralWhite&quot;)</span><br><span class="line">$DrawColor(&quot;ForestGreen&quot;)</span><br><span class="line">$DrawColor(&quot;Fuchsia&quot;)</span><br><span class="line">$DrawColor(&quot;Gainsboro&quot;)</span><br><span class="line">$DrawColor(&quot;GhostWhite&quot;)</span><br><span class="line">$DrawColor(&quot;Gold&quot;)</span><br><span class="line">$DrawColor(&quot;GoldenRod&quot;)</span><br><span class="line">$DrawColor(&quot;Gray&quot;)</span><br><span class="line">$DrawColor(&quot;Green&quot;)</span><br><span class="line">$DrawColor(&quot;GreenYellow&quot;)</span><br><span class="line">$DrawColor(&quot;Grey&quot;)</span><br><span class="line">$DrawColor(&quot;HoneyDew&quot;)</span><br><span class="line">$DrawColor(&quot;HotPink&quot;)</span><br><span class="line">$DrawColor(&quot;IMPLEMENTATION&quot;)</span><br><span class="line">$DrawColor(&quot;IndianRed&quot;)</span><br><span class="line">$DrawColor(&quot;Indigo&quot;)</span><br><span class="line">$DrawColor(&quot;Ivory&quot;)</span><br><span class="line">$DrawColor(&quot;Khaki&quot;)</span><br><span class="line">$DrawColor(&quot;Lavender&quot;)</span><br><span class="line">$DrawColor(&quot;LavenderBlush&quot;)</span><br><span class="line">$DrawColor(&quot;LawnGreen&quot;)</span><br><span class="line">$DrawColor(&quot;LemonChiffon&quot;)</span><br><span class="line">$DrawColor(&quot;LightBlue&quot;)</span><br><span class="line">$DrawColor(&quot;LightCoral&quot;)</span><br><span class="line">$DrawColor(&quot;LightCyan&quot;)</span><br><span class="line">$DrawColor(&quot;LightGoldenRodYellow&quot;)</span><br><span class="line">$DrawColor(&quot;LightGray&quot;)</span><br><span class="line">$DrawColor(&quot;LightGreen&quot;)</span><br><span class="line">$DrawColor(&quot;LightGrey&quot;)</span><br><span class="line">$DrawColor(&quot;LightPink&quot;)</span><br><span class="line">$DrawColor(&quot;LightSalmon&quot;)</span><br><span class="line">$DrawColor(&quot;LightSeaGreen&quot;)</span><br><span class="line">$DrawColor(&quot;LightSkyBlue&quot;)</span><br><span class="line">$DrawColor(&quot;LightSlateGray&quot;)</span><br><span class="line">$DrawColor(&quot;LightSlateGrey&quot;)</span><br><span class="line">$DrawColor(&quot;LightSteelBlue&quot;)</span><br><span class="line">$DrawColor(&quot;LightYellow&quot;)</span><br><span class="line">$DrawColor(&quot;Lime&quot;)</span><br><span class="line">$DrawColor(&quot;LimeGreen&quot;)</span><br><span class="line">$DrawColor(&quot;Linen&quot;)</span><br><span class="line">$DrawColor(&quot;MOTIVATION&quot;)</span><br><span class="line">$DrawColor(&quot;Magenta&quot;)</span><br><span class="line">$DrawColor(&quot;Maroon&quot;)</span><br><span class="line">$DrawColor(&quot;MediumAquaMarine&quot;)</span><br><span class="line">$DrawColor(&quot;MediumBlue&quot;)</span><br><span class="line">$DrawColor(&quot;MediumOrchid&quot;)</span><br><span class="line">$DrawColor(&quot;MediumPurple&quot;)</span><br><span class="line">$DrawColor(&quot;MediumSeaGreen&quot;)</span><br><span class="line">$DrawColor(&quot;MediumSlateBlue&quot;)</span><br><span class="line">$DrawColor(&quot;MediumSpringGreen&quot;)</span><br><span class="line">$DrawColor(&quot;MediumTurquoise&quot;)</span><br><span class="line">$DrawColor(&quot;MediumVioletRed&quot;)</span><br><span class="line">$DrawColor(&quot;MidnightBlue&quot;)</span><br><span class="line">$DrawColor(&quot;MintCream&quot;)</span><br><span class="line">$DrawColor(&quot;MistyRose&quot;)</span><br><span class="line">$DrawColor(&quot;Moccasin&quot;)</span><br><span class="line">$DrawColor(&quot;NavajoWhite&quot;)</span><br><span class="line">$DrawColor(&quot;Navy&quot;)</span><br><span class="line">$DrawColor(&quot;OldLace&quot;)</span><br><span class="line">$DrawColor(&quot;Olive&quot;)</span><br><span class="line">$DrawColor(&quot;OliveDrab&quot;)</span><br><span class="line">$DrawColor(&quot;Orange&quot;)</span><br><span class="line">$DrawColor(&quot;OrangeRed&quot;)</span><br><span class="line">$DrawColor(&quot;Orchid&quot;)</span><br><span class="line">$DrawColor(&quot;PHYSICAL&quot;)</span><br><span class="line">$DrawColor(&quot;PaleGoldenRod&quot;)</span><br><span class="line">$DrawColor(&quot;PaleGreen&quot;)</span><br><span class="line">$DrawColor(&quot;PaleTurquoise&quot;)</span><br><span class="line">$DrawColor(&quot;PaleVioletRed&quot;)</span><br><span class="line">$DrawColor(&quot;PapayaWhip&quot;)</span><br><span class="line">$DrawColor(&quot;PeachPuff&quot;)</span><br><span class="line">$DrawColor(&quot;Peru&quot;)</span><br><span class="line">$DrawColor(&quot;Pink&quot;)</span><br><span class="line">$DrawColor(&quot;Plum&quot;)</span><br><span class="line">$DrawColor(&quot;PowderBlue&quot;)</span><br><span class="line">$DrawColor(&quot;Purple&quot;)</span><br><span class="line">$DrawColor(&quot;Red&quot;)</span><br><span class="line">$DrawColor(&quot;RosyBrown&quot;)</span><br><span class="line">$DrawColor(&quot;RoyalBlue&quot;)</span><br><span class="line">$DrawColor(&quot;STRATEGY&quot;)</span><br><span class="line">$DrawColor(&quot;SaddleBrown&quot;)</span><br><span class="line">$DrawColor(&quot;Salmon&quot;)</span><br><span class="line">$DrawColor(&quot;SandyBrown&quot;)</span><br><span class="line">$DrawColor(&quot;SeaGreen&quot;)</span><br><span class="line">$DrawColor(&quot;SeaShell&quot;)</span><br><span class="line">$DrawColor(&quot;Sienna&quot;)</span><br><span class="line">$DrawColor(&quot;Silver&quot;)</span><br><span class="line">$DrawColor(&quot;SkyBlue&quot;)</span><br><span class="line">$DrawColor(&quot;SlateBlue&quot;)</span><br><span class="line">$DrawColor(&quot;SlateGray&quot;)</span><br><span class="line">$DrawColor(&quot;SlateGrey&quot;)</span><br><span class="line">$DrawColor(&quot;Snow&quot;)</span><br><span class="line">$DrawColor(&quot;SpringGreen&quot;)</span><br><span class="line">$DrawColor(&quot;SteelBlue&quot;)</span><br><span class="line">$DrawColor(&quot;TECHNOLOGY&quot;)</span><br><span class="line">$DrawColor(&quot;Tan&quot;)</span><br><span class="line">$DrawColor(&quot;Teal&quot;)</span><br><span class="line">$DrawColor(&quot;Thistle&quot;)</span><br><span class="line">$DrawColor(&quot;Tomato&quot;)</span><br><span class="line">$DrawColor(&quot;Turquoise&quot;)</span><br><span class="line">$DrawColor(&quot;Violet&quot;)</span><br><span class="line">$DrawColor(&quot;Wheat&quot;)</span><br><span class="line">$DrawColor(&quot;White&quot;)</span><br><span class="line">$DrawColor(&quot;WhiteSmoke&quot;)</span><br><span class="line">$DrawColor(&quot;Yellow&quot;)</span><br><span class="line">$DrawColor(&quot;YellowGreen&quot;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<p><img src="/resource/UML%E8%AF%AD%E6%B3%95%E5%AD%A6%E4%B9%A0/color_uml.png" alt="color_uml"></p>
<h3 id="附注">附注</h3>
<p><a target="_blank" rel="noopener" href="https://crashedmind.github.io/PlantUMLHitchhikersGuide/about/AboutPlantUML.html">PlantUML资料</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/06/27/2020-06-27-%E9%98%85%E8%AF%BBC++%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/27/2020-06-27-%E9%98%85%E8%AF%BBC++%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">阅读C++线程池源码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-27 16:37:47" itemprop="dateCreated datePublished" datetime="2020-06-27T16:37:47+08:00">2020-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-03-21 10:13:23" itemprop="dateModified" datetime="2024-03-21T10:13:23+08:00">2024-03-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">源码阅读</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="progschj-thread-pool">progschj/thread_pool</h2>
<p>Github上这个库(<a target="_blank" rel="noopener" href="https://github.com/progschj/ThreadPool/blob/master/ThreadPool.h">progschj/thread_pool</a>)的点赞最多，学习一下。</p>
<h3 id="接口定义">接口定义</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">ThreadPool</span>(<span class="type">size_t</span>);</span><br><span class="line">  <span class="comment">/// 任务入列</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">F</span>, <span class="keyword">class</span>... Args&gt;</span><br><span class="line">  <span class="function"><span class="keyword">auto</span> <span class="title">enqueue</span><span class="params">(F&amp;&amp; f, Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function">      -&gt; std::future&lt;<span class="keyword">typename</span> std::invoke_result&lt;<span class="title">F</span><span class="params">(Args...)</span>&gt;::type&gt;</span>;</span><br><span class="line">  ~<span class="built_in">ThreadPool</span>();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">/// 所有的工作线程</span></span><br><span class="line">  std::vector&lt;std::thread&gt; workers;</span><br><span class="line">  <span class="comment">/// 任务队列</span></span><br><span class="line">  std::queue&lt;std::function&lt;<span class="type">void</span>()&gt; &gt; tasks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 用于同步的互斥锁和条件变量</span></span><br><span class="line">  std::mutex queue_mutex;</span><br><span class="line">  std::condition_variable condition;</span><br><span class="line">  <span class="type">bool</span> stop;  <span class="comment">///&lt; 用于判断所有线程是否需要结束</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="构造函数和消费者实现">构造函数和消费者实现</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @name     ThreadPool</span></span><br><span class="line"><span class="comment">/// @brief    用于创建若干个线程，并规定消费者函数</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param    threads   [in]    要创建的线程数量</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @return   NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-06-27 16:17:50</span></span><br><span class="line"><span class="comment">/// @warning  线程安全</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="title">ThreadPool::ThreadPool</span><span class="params">(<span class="type">size_t</span> threads)</span> : stop(false) &#123;</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; threads; ++i)</span><br><span class="line">    workers.<span class="built_in">emplace_back</span>([<span class="keyword">this</span>] &#123;</span><br><span class="line">      <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        std::function&lt;<span class="built_in">void</span>()&gt; task;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/// 获取同步锁</span></span><br><span class="line">          std::unique_lock&lt;std::mutex&gt; <span class="built_in">lock</span>(<span class="keyword">this</span>-&gt;queue_mutex);</span><br><span class="line">          <span class="comment">/// 阻塞等待获取任务，直到任务队列不为空</span></span><br><span class="line">          <span class="keyword">this</span>-&gt;condition.<span class="built_in">wait</span>(</span><br><span class="line">              lock, [<span class="keyword">this</span>] &#123; <span class="keyword">return</span> <span class="keyword">this</span>-&gt;stop || !<span class="keyword">this</span>-&gt;tasks.<span class="built_in">empty</span>(); &#125;);</span><br><span class="line">          <span class="comment">/// 如果stop标志位为true，且任务列表都执行完毕后，该线程退出</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;stop &amp;&amp; <span class="keyword">this</span>-&gt;tasks.<span class="built_in">empty</span>()) <span class="keyword">return</span>;</span><br><span class="line">          <span class="comment">/// 从任务队列中拿出来一个任务</span></span><br><span class="line">          task = std::<span class="built_in">move</span>(<span class="keyword">this</span>-&gt;tasks.<span class="built_in">front</span>());</span><br><span class="line">          <span class="keyword">this</span>-&gt;tasks.<span class="built_in">pop</span>();</span><br><span class="line">        &#125;  <span class="comment">///&lt; 这里释放锁</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/// 执行该任务函数</span></span><br><span class="line">        <span class="built_in">task</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="析构函数">析构函数</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> ThreadPool::~<span class="built_in">ThreadPool</span>() &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex)</span></span>;</span><br><span class="line">    stop = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/// 在stop位, 置为true后通知所有线程执行一次，然后等待所有线程处理完任务后join()</span></span><br><span class="line">  condition.<span class="built_in">notify_all</span>();</span><br><span class="line">  <span class="keyword">for</span> (std::thread&amp; worker : workers) worker.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="生产者函数">生产者函数</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @name     enqueue</span></span><br><span class="line"><span class="comment">/// @brief    用于添加任务函数到任务队列中</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param    f     [in]    任务函数</span></span><br><span class="line"><span class="comment">/// @param    args  [in]    任务函数的入参列表</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @return   取决于任务函数的返回值</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-06-27 16:06:30</span></span><br><span class="line"><span class="comment">/// @warning  线程安全</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">F</span>, <span class="keyword">class</span>... Args&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">ThreadPool::enqueue</span><span class="params">(F&amp;&amp; f, Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function">    -&gt; std::future&lt;<span class="keyword">typename</span> std::invoke_result&lt;<span class="title">F</span><span class="params">(Args...)</span>&gt;::type&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">using</span> return_type = <span class="keyword">typename</span> std::invoke_result&lt;<span class="built_in">F</span>(Args...)&gt;::type;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 这里封装一个异步的线程并执行刚刚传入的函数，这个函数通过bind改类型为void()</span></span><br><span class="line">  <span class="keyword">auto</span> task = std::make_shared&lt;std::packaged_task&lt;<span class="built_in">return_type</span>()&gt; &gt;(</span><br><span class="line">      std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...));</span><br><span class="line">  <span class="comment">/// 创建一个这个函数的未来的值， 这个未来值不获取就不会进行计算</span></span><br><span class="line">  std::future&lt;return_type&gt; res = task-&gt;<span class="built_in">get_future</span>();</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 假如说没有让这个线程停止则继续，否则抛出异常阻止线程池结束后在入列</span></span><br><span class="line">    <span class="keyword">if</span> (stop) <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;enqueue on stopped ThreadPool&quot;</span>);</span><br><span class="line">    <span class="comment">/// 这个封装好的函数放入任务列表中</span></span><br><span class="line">    tasks.<span class="built_in">emplace</span>([task]() &#123; (*task)(); &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/// 通知一个阻塞中的线程，任务队列中有任务了</span></span><br><span class="line">  condition.<span class="built_in">notify_one</span>();</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/06/27/2020-06-27-C++%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/27/2020-06-27-C++%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3/" class="post-title-link" itemprop="url">C++ 异步运算接口</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-27 14:46:47" itemprop="dateCreated datePublished" datetime="2020-06-27T14:46:47+08:00">2020-06-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-28 14:29:44" itemprop="dateModified" datetime="2023-10-28T14:29:44+08:00">2023-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/c/" itemprop="url" rel="index"><span itemprop="name">c++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="std-async介绍">std::async介绍</h2>
<p>下面是一个很好的并行计算的例子。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_prime</span><span class="params">(<span class="type">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt; x; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (x % i == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/** is_prime(700020007)这个函数调用隐藏于主线程，异步执行 */</span></span><br><span class="line">    std::future&lt;<span class="type">bool</span>&gt; fut = std::<span class="built_in">async</span>(is_prime, <span class="number">700020007</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;please wait&quot;</span>;</span><br><span class="line">    std::<span class="function">chrono::milliseconds <span class="title">span</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">    <span class="comment">/** 这个异步调用函数等待100ms，如果没有计算完就继续等待 */</span></span><br><span class="line">    <span class="keyword">while</span> (fut.<span class="built_in">wait_for</span>(span) != std::future_status::ready)</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;.&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 计算完毕后，获取函数返回值 */</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;final result: &quot;</span> &lt;&lt; std::boolalpha &lt;&lt; fut.<span class="built_in">get</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>std::async中的第一个参数是启动策略，它控制std::async的异步行为，我们可以用三种不同的启动策略来创建std::async<br>
<strong>·std::launch::async</strong><br>
保证异步行为，即传递函数将在单独的线程中执行<br>
<strong>·std::launch::deferred</strong><br>
当其他线程调用get()来访问共享状态时，将调用非异步行为<br>
<strong>·std::launch::async | std::launch::deferred</strong><br>
默认行为。有了这个启动策略，它可以异步运行或不运行，这取决于系统的负载，但我们无法控制它。</p>
<p>见下面例子：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">fetchDataFromDB</span><span class="params">(std::string recvData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//确保函数要5秒才能执行完成</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="built_in">seconds</span>(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理创建数据库连接、获取数据等事情</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;DB_&quot;</span> + recvData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">fetchDataFromFile</span><span class="params">(std::string recvData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//确保函数要5秒才能执行完成</span></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="built_in">seconds</span>(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理获取文件数据</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;File_&quot;</span> + recvData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//获取开始时间</span></span><br><span class="line">    system_clock::time_point start = system_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 使用std::launch::async，来指定其异步执行 */</span></span><br><span class="line">    std::future&lt;std::string&gt; resultFromDB = std::<span class="built_in">async</span>(std::launch::async,</span><br><span class="line">                                                    fetchDataFromDB, <span class="string">&quot;Data&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从文件获取数据</span></span><br><span class="line">    std::string fileData = <span class="built_in">fetchDataFromFile</span>(<span class="string">&quot;Data&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从DB获取数据</span></span><br><span class="line">    <span class="comment">//数据在future&lt;std::string&gt;对象中可获取之前，将一直阻塞</span></span><br><span class="line">    std::string dbData = resultFromDB.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取结束时间</span></span><br><span class="line">    <span class="keyword">auto</span> end = system_clock::<span class="built_in">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> diff = <span class="built_in">duration_cast</span>&lt;std::chrono::seconds&gt;(end - start).<span class="built_in">count</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Total Time taken= &quot;</span> &lt;&lt; diff &lt;&lt; <span class="string">&quot;Seconds&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//组装数据</span></span><br><span class="line">    std::string data = dbData + <span class="string">&quot; :: &quot;</span> + fileData;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//输出组装的数据</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Data = &quot;</span> &lt;&lt; data &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-promise介绍">std::promise介绍</h2>
<p>std::promise的作用就是提供一个不同线程之间的数据同步机制，它可以存储一个某种类型的值，并将其传递给对应的future， 即使这个future不在同一个线程中也可以安全的访问到这个值</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>       <span class="comment">// std::cout</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span>     <span class="comment">// std::ref</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>         <span class="comment">// std::thread</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span>         <span class="comment">// std::promise, std::future</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_int</span> <span class="params">(std::future&lt;<span class="type">int</span>&gt;&amp; fut)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Enter print_int: &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> x = fut.<span class="built_in">get</span>();  <span class="comment">///&lt; 在这里会等待外部std::promise变量set_value进来，否则会一致阻塞在这里</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;value: &quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::promise&lt;<span class="type">int</span>&gt; prom;                      <span class="comment">// 创建一个std::promise变量</span></span><br><span class="line"></span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; fut = prom.<span class="built_in">get_future</span>();    <span class="comment">// 创建一个std::future变量</span></span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread <span class="title">th1</span> <span class="params">(print_int, std::ref(fut))</span></span>;  <span class="comment">// 创建一个线程执行函数print_int</span></span><br><span class="line"></span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">3</span>));</span><br><span class="line">    prom.<span class="built_in">set_value</span> (<span class="number">10</span>);                         <span class="comment">// 传值进入线程th1</span></span><br><span class="line"></span><br><span class="line">    th<span class="number">1.</span><span class="built_in">join</span>();</span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-packaged-task介绍">std::packaged_task介绍</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>     <span class="comment">// std::cout</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span>       <span class="comment">// std::packaged_task, std::future</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span>       <span class="comment">// std::chrono::seconds</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span>       <span class="comment">// std::thread, std::this_thread::sleep_for</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// count down taking a second for each value:</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">countdown</span> <span class="params">(<span class="type">int</span> from, <span class="type">int</span> to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = from; i != to; --i)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; i &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Lift off!\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> from - to;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个std::packaged_task对象</span></span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>&gt; <span class="title">tsk</span> <span class="params">(countdown)</span></span>;</span><br><span class="line">    <span class="comment">// 创建一个std::future对象，用于跨线程异步获取该线程返回的值</span></span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; ret = tsk.<span class="built_in">get_future</span>();</span><br><span class="line">	<span class="comment">// 把线程对象移动进一个可运行的线程中</span></span><br><span class="line">    <span class="function">std::thread <span class="title">th</span> <span class="params">(std::move(tsk), <span class="number">10</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 让该线程从主线程中分离</span></span><br><span class="line">    th.<span class="built_in">detach</span>();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 利用std::future对象来获取已经分离开的线程运行是否结束的返回的值</span></span><br><span class="line">    <span class="type">int</span> value = ret.<span class="built_in">get</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;The countdown lasted for &quot;</span> &lt;&lt; value &lt;&lt; <span class="string">&quot; seconds.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="硬件支持的线程数量">硬件支持的线程数量</h2>
<p>由于硬件支持的并行线程数量有限，如果创建线程的数量比硬件支持的数量要多，那么CPU进行的上下文切换可能会浪费大量时间，所以了解硬件支持的线程数量是高效并行编程的重点。</p>
<p>使用<code>std::thread::hardware_concurrency()</code>来获取硬件支持的线程数量。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> n = std::thread::<span class="built_in">hardware_concurrency</span>();</span><br><span class="line">    std::cout &lt;&lt; n &lt;&lt; <span class="string">&quot; concurrent threads are supported.\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-thread-yield介绍">std::thread::yield介绍</h2>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/11048946/stdthis-threadyield-vs-stdthis-threadsleep-for">关于std::thread::yield 和 std::sleep_for的比较</a></p>
<p>例子：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">worker_thread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        std::function&lt;<span class="type">void</span>()&gt; task;</span><br><span class="line">        <span class="keyword">if</span> (work_queue.<span class="built_in">try_pop</span>(task)) &#123;</span><br><span class="line">            <span class="comment">/// 获取到任务就运行</span></span><br><span class="line">            <span class="built_in">task</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/// 没有获取到就休息一下</span></span><br><span class="line">            std::this_thread::<span class="built_in">yield</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://mercy1101.github.io/2020/06/26/2020-06-27-%E9%98%85%E8%AF%BBspdlog-thread_pool%E6%BA%90%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="李建聪">
      <meta itemprop="description" content="在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李建聪的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/26/2020-06-27-%E9%98%85%E8%AF%BBspdlog-thread_pool%E6%BA%90%E7%A0%81/" class="post-title-link" itemprop="url">阅读spdlog-thread_pool源码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-26 09:18:47" itemprop="dateCreated datePublished" datetime="2020-06-26T09:18:47+08:00">2020-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-28 14:29:44" itemprop="dateModified" datetime="2023-10-28T14:29:44+08:00">2023-10-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/" itemprop="url" rel="index"><span itemprop="name">源码阅读</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="thread-pool-源码学习">thread_pool 源码学习</h2>
<h3 id="源码定义">源码定义</h3>
<p>我们先概览一下<a target="_blank" rel="noopener" href="https://github.com/gabime/spdlog/blob/v1.x/include/spdlog/details/thread_pool.h">spdlog-thread_pool定义</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SPDLOG_API</span> thread_pool</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> item_type = async_msg;</span><br><span class="line">    <span class="keyword">using</span> q_type = details::mpmc_blocking_queue&lt;item_type&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">thread_pool</span>(<span class="type">size_t</span> q_max_items, <span class="type">size_t</span> threads_n,</span><br><span class="line">                std::function&lt;<span class="built_in">void</span>()&gt; on_thread_start);</span><br><span class="line">    <span class="built_in">thread_pool</span>(<span class="type">size_t</span> q_max_items, <span class="type">size_t</span> threads_n);</span><br><span class="line">    ~<span class="built_in">thread_pool</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">thread_pool</span>(<span class="type">const</span> thread_pool &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    thread_pool &amp;<span class="keyword">operator</span>=(thread_pool &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">post_log</span><span class="params">(async_logger_ptr &amp;&amp;worker_ptr, <span class="type">const</span> details::log_msg &amp;msg,</span></span></span><br><span class="line"><span class="params"><span class="function">                  async_overflow_policy overflow_policy)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">post_flush</span><span class="params">(async_logger_ptr &amp;&amp;worker_ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">                    async_overflow_policy overflow_policy)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">overrun_counter</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    q_type q_; <span class="comment">///&lt; 任务队列</span></span><br><span class="line">    std::vector&lt;std::thread&gt; threads_;  <span class="comment">///&lt; 线程池</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">post_async_msg_</span><span class="params">(async_msg &amp;&amp;new_msg,</span></span></span><br><span class="line"><span class="params"><span class="function">                         async_overflow_policy overflow_policy)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">worker_loop_</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">process_next_msg_</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="基本成员函数">基本成员函数</h3>
<p>首先我们从thread_pll中最基本的五个成员函数开始看。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">thread_pool</span>(<span class="type">size_t</span> q_max_items, <span class="type">size_t</span> threads_n,</span><br><span class="line">            std::function&lt;<span class="built_in">void</span>()&gt; on_thread_start);</span><br><span class="line"><span class="built_in">thread_pool</span>(<span class="type">size_t</span> q_max_items, <span class="type">size_t</span> threads_n);</span><br><span class="line"></span><br><span class="line"><span class="comment">// message all threads to terminate gracefully join them</span></span><br><span class="line">~<span class="built_in">thread_pool</span>();</span><br><span class="line"></span><br><span class="line"><span class="built_in">thread_pool</span>(<span class="type">const</span> thread_pool &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">thread_pool &amp;<span class="keyword">operator</span>=(thread_pool &amp;&amp;) = <span class="keyword">delete</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到该类删除了拷贝构造，移动构造，标志该类不可以被拷贝和移动。<br>
其中有两个构造函数，我们来详细看看它们的实现。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @name     thread_pool</span></span><br><span class="line"><span class="comment">/// @brief    构造函数，创建了一定数量的线程，并规定执行哪个函数</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param    q_max_item      [in] 用于初始化任务队列最大的数量</span></span><br><span class="line"><span class="comment">/// @param    thread_n        [in] 用于初始化最大线程数量</span></span><br><span class="line"><span class="comment">/// @param    on_thread_start [in] 每个线程执行的初始化函数(只执行一次)</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @return   NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-06-27 13:32:47</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="title">thread_pool</span><span class="params">(<span class="type">size_t</span> q_max_items, <span class="type">size_t</span> threads_n,</span></span></span><br><span class="line"><span class="params"><span class="function">                   std::function&lt;<span class="type">void</span>()&gt; on_thread_start)</span></span></span><br><span class="line"><span class="function">    : q_(q_max_items) ///&lt; 任务队列的最大数目</span></span><br><span class="line"><span class="function">&#123;</span></span><br><span class="line">  <span class="keyword">if</span> (threads_n == <span class="number">0</span> || threads_n &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span>(</span><br><span class="line">        <span class="string">&quot;spdlog::thread_pool(): invalid threads_n param (valid &quot;</span></span><br><span class="line">        <span class="string">&quot;range is 1-1000)&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; threads_n; i++) &#123;</span><br><span class="line">    threads_.<span class="built_in">emplace_back</span>([<span class="keyword">this</span>, on_thread_start] &#123;</span><br><span class="line">      <span class="comment">/// 线程开始时候需要执行的初始函数</span></span><br><span class="line">      <span class="built_in">on_thread_start</span>();</span><br><span class="line">      <span class="comment">/// 主任务循环</span></span><br><span class="line">      <span class="keyword">this</span>-&gt;thread_pool::<span class="built_in">worker_loop_</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 委托构造函数，用于输入默认入参 std::function&lt;void()&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="title">thread_pool::thread_pool</span><span class="params">(<span class="type">size_t</span> q_max_items, <span class="type">size_t</span> threads_n)</span></span></span><br><span class="line"><span class="function">    : thread_pool(q_max_items, threads_n, [] &#123;</span>&#125;) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>接着我们来看一下析构函数执行了什么</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 告诉所有线程中止，并且执行join()</span></span><br><span class="line">~<span class="built_in">thread_pool</span>() &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; threads_.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">      <span class="comment">/// 对每一个线程池发送一个中止消息</span></span><br><span class="line">      <span class="built_in">post_async_msg_</span>(<span class="built_in">async_msg</span>(async_msg_type::terminate),</span><br><span class="line">                      async_overflow_policy::block);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;t : threads_) &#123;</span><br><span class="line">      <span class="comment">/// 等待每一个线程的结束时的join</span></span><br><span class="line">      t.<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">    <span class="comment">/// 析构函数中不能有异常，所以在这里做一个全捕获</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="生产者逻辑">生产者逻辑</h3>
<p>接着我们来看公有的两个接口函数的实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 用于发送任务消息，并判断是否需要打印到命令行或写入文件</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">post_log</span><span class="params">(async_logger_ptr &amp;&amp;worker_ptr, <span class="type">const</span> log_msg &amp;msg,</span></span></span><br><span class="line"><span class="params"><span class="function">              async_overflow_policy overflow_policy)</span> </span>&#123;</span><br><span class="line">  <span class="function">async_msg <span class="title">async_m</span><span class="params">(std::move(worker_ptr), async_msg_type::log, msg)</span></span>;</span><br><span class="line">  <span class="built_in">post_async_msg_</span>(std::<span class="built_in">move</span>(async_m), overflow_policy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 用于发送任务消息，并判断是否需要马上写入文件</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">post_flush</span><span class="params">(async_logger_ptr &amp;&amp;worker_ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">                async_overflow_policy overflow_policy)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">post_async_msg_</span>(<span class="built_in">async_msg</span>(std::<span class="built_in">move</span>(worker_ptr), async_msg_type::flush),</span><br><span class="line">                  overflow_policy);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 用于返回任务队列溢出了多少条</span></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">overrun_counter</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> q_.<span class="built_in">overrun_counter</span>(); &#125;</span><br></pre></td></tr></table></figure>
<p><code>post_log</code> 和 <code>post_flush</code> 执行了一个差不多的任务，就是写日志，这两个函数都调用了<code>post_async_msg_()</code>来执行具体的任务们就来看看<code>post_async_msg_()</code>到底执行了什么。</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @name     post_async_msg_</span></span><br><span class="line"><span class="comment">/// @brief    用于从队列中插入消息, 相当于生产者</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param    new_msg         [in] 用于传入异步日志消息(使用右值方便移动)</span></span><br><span class="line"><span class="comment">/// @param    overflow_policy [in] 消息数量溢出的策略</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @return   NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-06-27 13:42:18</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">post_async_msg_</span><span class="params">(async_msg &amp;&amp;new_msg,</span></span></span><br><span class="line"><span class="params"><span class="function">                     async_overflow_policy overflow_policy)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (overflow_policy == async_overflow_policy::block) &#123;</span><br><span class="line">    <span class="comment">/// 阻塞至消息队列中有空间来插入消息</span></span><br><span class="line">    q_.<span class="built_in">enqueue</span>(std::<span class="built_in">move</span>(new_msg));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/// 立即插入队列且队列满时丢弃老的消息</span></span><br><span class="line">    q_.<span class="built_in">enqueue_nowait</span>(std::<span class="built_in">move</span>(new_msg));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="消费者逻辑">消费者逻辑</h3>
<p>如上面的实现，我们知道这是一个生产者，从外部插入到本对象内的任务队列，等待消费者来处理这些消息<br>
我们来看看消费者到底执行了什么。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @name     worker_loop_</span></span><br><span class="line"><span class="comment">/// @brief    用于每个线程执行的死循环，当process_next_msg_返回false时候</span></span><br><span class="line"><span class="comment">///           线程自己退出</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param    NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @return   NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-06-27 13:51:13</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">worker_loop_</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/// 如果处理消息没有返回false，就一致执行该函数</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">process_next_msg_</span>()) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// @name     process_next_msg_</span></span><br><span class="line"><span class="comment">/// @brief    处理队列中的下一个消息，相当于消费者</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param    NONE</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @return   如果不是中止线程消息，则返回true, 反之返回false</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @date     2020-06-27 13:53:45</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">process_next_msg_</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  async_msg incoming_async_msg;</span><br><span class="line">  <span class="comment">/// 从任务消息队列中取消息，如果没有任务则等待获取任务,</span></span><br><span class="line">  <span class="comment">/// 如十秒后仍然没有获取到则直接返回</span></span><br><span class="line">  <span class="type">bool</span> dequeued =</span><br><span class="line">      q_.<span class="built_in">dequeue_for</span>(incoming_async_msg, std::chrono::<span class="built_in">seconds</span>(<span class="number">10</span>));</span><br><span class="line">  <span class="comment">/// 如果获取任务消息失败则直接返回true</span></span><br><span class="line">  <span class="keyword">if</span> (!dequeued) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 获取到消息后则进行处理</span></span><br><span class="line">  <span class="keyword">switch</span> (incoming_async_msg.msg_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> async_msg_type::log: &#123;</span><br><span class="line">      <span class="comment">/// 打印消息到命令行且判断是否要马上刷新文件</span></span><br><span class="line">      incoming_async_msg.worker_ptr-&gt;<span class="built_in">backend_sink_it_</span>(incoming_async_msg);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> async_msg_type::flush: &#123;</span><br><span class="line">      <span class="comment">/// 刷新文件</span></span><br><span class="line">      incoming_async_msg.worker_ptr-&gt;<span class="built_in">backend_flush_</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> async_msg_type::terminate: &#123;</span><br><span class="line">      <span class="comment">/// 用于终止本线程池的信号</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>: &#123;</span><br><span class="line">      <span class="built_in">assert</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码的逻辑我们可以看到：首先由<code>worker_loop()</code>函数来不停的执行消费者函数。<br>
而消费者函数在不停地去任务队列中获取任务最后由<code>backend_sink_it_()</code> 和 <code>backend_flush_()</code>两个函数来执行真正地任务。</p>
<h3 id="任务队列">任务队列</h3>
<p>很简单的一个消费者和生产者的队列，但最核心的部分被一个任务队列<code>mpmc_blocking_queue&lt;async_msg&gt;</code>给封装了，让我们继续深入来看看这个任务队列。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">mpmc_blocking_queue</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> item_type = T;</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">mpmc_blocking_queue</span><span class="params">(<span class="type">size_t</span> max_items)</span> : q_(max_items) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 尝试入列，如果空间不足则阻塞</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">enqueue</span><span class="params">(T &amp;&amp;item)</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex_)</span></span>;</span><br><span class="line">      pop_cv_.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>] &#123; <span class="keyword">return</span> !<span class="keyword">this</span>-&gt;q_.<span class="built_in">full</span>(); &#125;);</span><br><span class="line">      q_.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(item));</span><br><span class="line">    &#125;</span><br><span class="line">    push_cv_.<span class="built_in">notify_one</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 马上入列，如果没有空间则丢弃队列中老的消息</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">enqueue_nowait</span><span class="params">(T &amp;&amp;item)</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex_)</span></span>;</span><br><span class="line">      q_.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(item));</span><br><span class="line">    &#125;</span><br><span class="line">    push_cv_.<span class="built_in">notify_one</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 尝试出列。如果队列中没有消息，则等待到超时然后再次尝试</span></span><br><span class="line">  <span class="comment">/// 假如出列成功则返回true, 否则返回false</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">dequeue_for</span><span class="params">(T &amp;popped_item, std::chrono::milliseconds wait_duration)</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex_)</span></span>;</span><br><span class="line">      <span class="keyword">if</span> (!push_cv_.<span class="built_in">wait_for</span>(lock, wait_duration,</span><br><span class="line">                             [<span class="keyword">this</span>] &#123; <span class="keyword">return</span> !<span class="keyword">this</span>-&gt;q_.<span class="built_in">empty</span>(); &#125;)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      popped_item = std::<span class="built_in">move</span>(q_.<span class="built_in">front</span>());</span><br><span class="line">      q_.<span class="built_in">pop_front</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    pop_cv_.<span class="built_in">notify_one</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">size_t</span> <span class="title">overrun_counter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex_)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> q_.<span class="built_in">overrun_counter</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  std::mutex queue_mutex_;           <span class="comment">///&lt; 用于控制整个对象的锁</span></span><br><span class="line">  std::condition_variable push_cv_;  <span class="comment">///&lt; 用于入列的条件变量</span></span><br><span class="line">  std::condition_variable pop_cv_;   <span class="comment">///&lt; 用于出列的条件变量</span></span><br><span class="line">  circular_q&lt;T&gt; q_;                  <span class="comment">///&lt; 用于保存信息的队列</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们来看看这个队列是怎么实现线程安全的。<br>
其中<code>q_</code>这个循环队列不是线程安全的，所以加上了一个<code>queue_mutex</code> 这个互斥锁用来同步所有成员函数的顺序并配合条件变量实现等待获取的功能。</p>
<p><code>spdlog-thread_pool</code> 的实现逻辑很清晰，我们可以对比一下Github上另一个thread-pool: <a target="_blank" rel="noopener" href="https://github.com/progschj/ThreadPool/blob/master/ThreadPool.h">progschj/ThreadPool</a> 的实现。<br>
由于需要写入的任务很明确，就是处理异步日志，所以任务的队列直接写死了处理异步日志消息。而progschj/ThreadPool的实现则更加灵活。我们可以看看我的另一篇博客<a href="./_site/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/2020/06/27/%E9%98%85%E8%AF%BB%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BA%90%E7%A0%81.html">阅读progschj/thread_pool源码</a>对progschj/ThreadPool的介绍</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">李建聪</p>
  <div class="site-description" itemprop="description">在不断开放的世界中，我们的力量来源于我们能构建的连接，而非单一的智慧。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">82</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiancong Li</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
